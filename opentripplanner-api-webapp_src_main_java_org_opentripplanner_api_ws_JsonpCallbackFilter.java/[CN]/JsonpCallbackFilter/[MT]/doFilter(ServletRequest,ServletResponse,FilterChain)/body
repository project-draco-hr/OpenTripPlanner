{
  HttpServletRequest httpRequest=(HttpServletRequest)request;
  HttpServletResponse httpResponse=(HttpServletResponse)response;
  @SuppressWarnings("unchecked") Map<String,String[]> parms=httpRequest.getParameterMap();
  if (parms.containsKey("callback")) {
    if (log.isDebugEnabled())     log.debug("Wrapping response with JSONP callback '" + parms.get("callback")[0] + "'");
    OutputStream out=httpResponse.getOutputStream();
    GenericResponseWrapper wrapper=new GenericResponseWrapper(httpResponse);
    chain.doFilter(request,wrapper);
    out.write(new String(parms.get("callback")[0] + "(").getBytes());
    out.write(wrapper.getData());
    out.write(new String(");").getBytes());
    wrapper.setContentType("text/javascript;charset=UTF-8");
    out.close();
  }
 else {
    chain.doFilter(request,response);
  }
}
