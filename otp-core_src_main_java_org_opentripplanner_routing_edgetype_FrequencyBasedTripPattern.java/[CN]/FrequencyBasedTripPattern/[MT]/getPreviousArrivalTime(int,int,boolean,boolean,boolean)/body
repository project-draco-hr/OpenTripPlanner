{
  int mask=pickup ? TableTripPattern.MASK_PICKUP : TableTripPattern.MASK_DROPOFF;
  int shift=pickup ? TableTripPattern.SHIFT_PICKUP : TableTripPattern.SHIFT_DROPOFF;
  if ((perStopFlags[stopIndex + 1] & mask) >> shift == TableTripPattern.NO_PICKUP) {
    return -1;
  }
  if (wheelchairAccessible && (perStopFlags[stopIndex] & TableTripPattern.FLAG_WHEELCHAIR_ACCESSIBLE) == 0) {
    return -1;
  }
  if (wheelchairAccessible || bikesAllowed) {
    int flags=(bikesAllowed ? TableTripPattern.FLAG_BIKES_ALLOWED : 0) | (wheelchairAccessible ? TableTripPattern.FLAG_WHEELCHAIR_ACCESSIBLE : 0);
    if ((tripFlags & flags) == 0) {
      return -1;
    }
  }
  int stopArrivalTimeOffset=arrivalTimes[stopIndex];
  int beforeTimeAtStart=beforeTime - stopArrivalTimeOffset;
  int timeRange=Arrays.binarySearch(timeRangeEnd,beforeTimeAtStart);
  if (timeRange < 0) {
    timeRange=-timeRange - 1;
  }
  if (timeRange >= timeRangeStart.length)   timeRange-=1;
  if (beforeTimeAtStart < timeRangeStart[timeRange])   timeRange-=1;
  if (timeRange < 0)   return -1;
  int frequency=timeRangeFrequency[timeRange];
  int frequencyOffset=(timeRangeEnd[timeRange] - timeRangeStart[timeRange]) % frequency;
  int lastArrivalTimeInRange=stopArrivalTimeOffset + timeRangeEnd[timeRange] - frequencyOffset;
  int arrivalTime;
  if (exact) {
    if (beforeTime > lastArrivalTimeInRange) {
      arrivalTime=lastArrivalTimeInRange;
    }
 else {
      int offset=(lastArrivalTimeInRange - beforeTime) % frequency;
      if (offset == 0)       offset=frequency;
      arrivalTime=beforeTime - frequency + offset;
    }
  }
 else {
    arrivalTime=beforeTime - frequency;
  }
  int arrivalTimeAtFirstStop=arrivalTime - stopArrivalTimeOffset;
  if (arrivalTimeAtFirstStop < timeRangeEnd[timeRange] && arrivalTimeAtFirstStop >= timeRangeStart[timeRange]) {
    return arrivalTime;
  }
  return -1;
}
