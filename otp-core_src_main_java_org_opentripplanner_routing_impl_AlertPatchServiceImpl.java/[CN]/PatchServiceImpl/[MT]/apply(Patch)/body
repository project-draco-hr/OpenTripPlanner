{
  if (graph == null)   graph=graphService.getGraph();
  if (patches.containsKey(patch.getId())) {
    expire(patches.get(patch.getId()));
  }
  patch.apply(graph);
  patches.put(patch.getId(),patch);
  if (patch instanceof AlertPatch) {
    AlertPatch alertPatch=(AlertPatch)patch;
    AgencyAndId stop=alertPatch.getStop();
    if (stop != null) {
      patchesByStop.put(stop,patch);
    }
    AgencyAndId route=alertPatch.getRoute();
    if (route != null) {
      patchesByRoute.put(route,patch);
    }
  }
}
