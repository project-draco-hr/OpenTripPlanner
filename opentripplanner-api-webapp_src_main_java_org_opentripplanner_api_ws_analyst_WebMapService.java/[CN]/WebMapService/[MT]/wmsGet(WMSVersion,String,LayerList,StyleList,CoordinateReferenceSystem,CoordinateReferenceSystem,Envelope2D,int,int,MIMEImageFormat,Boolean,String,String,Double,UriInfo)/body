{
  if (request.equals("getCapabilities"))   return getCapabilitiesResponse();
  if (resolution != null) {
    width=(int)Math.ceil(bbox.width / resolution);
    height=(int)Math.ceil(bbox.height / resolution);
  }
  if (version == new WMSVersion("1.3.0") && crs != null)   srs=crs;
  TraverseOptions reqA=this.buildRequest(0);
  TraverseOptions reqB=this.buildRequest(1);
  LOG.debug("params {}",uriInfo.getQueryParameters());
  LOG.debug("layers = {}",layers);
  LOG.debug("styles = {}",styles);
  LOG.debug("version = {}",version);
  LOG.debug("srs = {}",srs.getName());
  LOG.debug("bbox = {}",bbox);
  LOG.debug("search time = {}",reqA.getDateTime());
  bbox.setCoordinateReferenceSystem(srs);
  TileRequest tileRequest=new TileRequest(bbox,width,height);
  Layer layer=layers.get(0);
  Style style=styles.get(0);
  RenderRequest renderRequest=new RenderRequest(format,layer,style,transparent);
  if (layer != Layer.DIFFERENCE) {
    reqB=null;
  }
  return renderer.getResponse(tileRequest,reqA,reqB,renderRequest);
}
