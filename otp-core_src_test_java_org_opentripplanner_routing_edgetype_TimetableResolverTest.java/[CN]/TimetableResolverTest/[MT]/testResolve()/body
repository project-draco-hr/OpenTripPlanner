{
  ServiceDate today=new ServiceDate();
  ServiceDate yesterday=today.previous();
  ServiceDate tomorrow=today.next();
  TripPattern pattern=patternIndex.get(new AgencyAndId("agency","1.1"));
  TimetableResolver resolver=new TimetableResolver();
  Timetable scheduled=resolver.resolve(pattern,today);
  assertEquals(scheduled,resolver.resolve(pattern,null));
  TripDescriptor.Builder tripDescriptorBuilder=TripDescriptor.newBuilder();
  tripDescriptorBuilder.setTripId("1.1");
  tripDescriptorBuilder.setScheduleRelationship(ScheduleRelationship.CANCELED);
  TripUpdate.Builder tripUpdateBuilder=TripUpdate.newBuilder();
  tripUpdateBuilder.setTrip(tripDescriptorBuilder);
  TripUpdate tripUpdate=tripUpdateBuilder.build();
  resolver.update(pattern,tripUpdate,"agency",timeZone,today);
  Timetable forNow=resolver.resolve(pattern,today);
  assertEquals(scheduled,resolver.resolve(pattern,yesterday));
  assertNotSame(scheduled,forNow);
  assertEquals(scheduled,resolver.resolve(pattern,tomorrow));
  assertEquals(scheduled,resolver.resolve(pattern,null));
  resolver.update(pattern,tripUpdate,"agency",timeZone,yesterday);
  Timetable forYesterday=resolver.resolve(pattern,yesterday);
  assertNotSame(scheduled,forYesterday);
  assertNotSame(scheduled,forNow);
  assertEquals(scheduled,resolver.resolve(pattern,tomorrow));
  assertEquals(scheduled,resolver.resolve(pattern,null));
}
