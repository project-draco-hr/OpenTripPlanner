{
  Date now=new Date();
  Set<AgencyAndId> serviceIdsActive=gtfs.getServiceIdsOnDate(now);
  List<WmsDeparture> allDepartures=new ArrayList<WmsDeparture>();
  List<StopTime> stopTimes=gtfs.getStopTimesForStopId(stop.getId().toString());
  for (  StopTime stopTime : stopTimes) {
    Trip trip=stopTime.getTrip();
    AgencyAndId tripServiceId=trip.getServiceId();
    if (!serviceIdsActive.contains(tripServiceId)) {
      continue;
    }
    int departureTime=stopTime.getDepartureTime();
    Date date=convertTimeToDate(departureTime);
    if (date.compareTo(now) > 0) {
      String headsign=trip.getTripHeadsign();
      Route route=trip.getRoute();
      WmsDeparture departure=new WmsDeparture(route,headsign,date);
      allDepartures.add(departure);
    }
  }
  Collections.sort(allDepartures);
  List<WmsDeparture> result=new ArrayList<WmsDeparture>();
  for (int i=0; i < Math.min(nDepartures,allDepartures.size()); i++) {
    result.add(allDepartures.get(i));
  }
  return result;
}
