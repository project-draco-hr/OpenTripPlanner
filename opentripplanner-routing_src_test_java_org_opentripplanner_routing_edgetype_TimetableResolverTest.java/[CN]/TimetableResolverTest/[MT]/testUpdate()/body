{
  ServiceDate today=new ServiceDate();
  ServiceDate yesterday=today.previous();
  TableTripPattern pattern=patternIndex.get(new AgencyAndId("agency","1.1"));
  TimetableResolver resolver=new TimetableResolver();
  Timetable origNow=resolver.resolve(pattern,today);
  resolver.update(pattern,TripUpdate.forCanceledTrip(pattern.getTrip(0).getId(),0,today));
  Timetable updatedNow=resolver.resolve(pattern,today);
  assertNotSame(origNow,updatedNow);
  resolver.update(pattern,TripUpdate.forCanceledTrip(pattern.getTrip(0).getId(),0,today));
  assertEquals(updatedNow,resolver.resolve(pattern,today));
  resolver.update(pattern,TripUpdate.forCanceledTrip(pattern.getTrip(0).getId(),0,yesterday));
  assertNotSame(origNow,resolver.resolve(pattern,yesterday));
  assertNotSame(updatedNow,resolver.resolve(pattern,yesterday));
  TimetableResolver snapshot=resolver.commit();
  snapshot.update(pattern,TripUpdate.forCanceledTrip(pattern.getTrip(0).getId(),0,yesterday));
}
