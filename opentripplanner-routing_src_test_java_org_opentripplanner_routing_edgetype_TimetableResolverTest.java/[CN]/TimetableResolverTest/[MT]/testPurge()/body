{
  ServiceDate today=new ServiceDate();
  ServiceDate yesterday=today.previous();
  TableTripPattern pattern=patternIndex.get(new AgencyAndId("agency","1.1"));
  TimetableResolver resolver=new TimetableResolver();
  assertTrue(resolver.update(pattern,TripUpdate.forCanceledTrip(pattern.getTrip(0).getId(),0,today)));
  assertTrue(resolver.update(pattern,TripUpdate.forCanceledTrip(pattern.getTrip(0).getId(),0,yesterday)));
  assertNotSame(resolver.resolve(pattern,yesterday),resolver.resolve(pattern,null));
  assertNotSame(resolver.resolve(pattern,today),resolver.resolve(pattern,null));
  assertNotNull(resolver.commit());
  assertFalse(resolver.isDirty());
  assertTrue(resolver.purgeExpiredData(yesterday));
  assertFalse(resolver.purgeExpiredData(yesterday));
  assertEquals(resolver.resolve(pattern,yesterday),resolver.resolve(pattern,null));
  assertNotSame(resolver.resolve(pattern,today),resolver.resolve(pattern,null));
  assertNull(resolver.commit());
  assertFalse(resolver.isDirty());
}
