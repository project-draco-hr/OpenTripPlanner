{
  BorderLayout layout=new BorderLayout();
  setLayout(layout);
  Container pane=getContentPane();
  showGraph=new ShowGraph(this,getGraph());
  pane.add(showGraph,BorderLayout.CENTER);
  leftPanel=new JPanel();
  leftPanel.setLayout(new BorderLayout());
  pane.add(leftPanel,BorderLayout.LINE_START);
  JPanel routingPanel=new JPanel();
  routingPanel.setLayout(new GridLayout(0,2));
  leftPanel.add(routingPanel,BorderLayout.NORTH);
  JButton setSourceVertexButton=new JButton("set source");
  setSourceVertexButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      Object selected=nearbyVertices.getSelectedValue();
      if (selected != null) {
        sourceVertex.setText(selected.toString());
      }
    }
  }
);
  routingPanel.add(setSourceVertexButton);
  sourceVertex=new JTextField();
  routingPanel.add(sourceVertex);
  JButton setSinkVertexButton=new JButton("set sink");
  setSinkVertexButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      Object selected=nearbyVertices.getSelectedValue();
      if (selected != null) {
        sinkVertex.setText(selected.toString());
      }
    }
  }
);
  routingPanel.add(setSinkVertexButton);
  sinkVertex=new JTextField();
  routingPanel.add(sinkVertex);
  JButton resetSearchDateButton=new JButton("now ->");
  resetSearchDateButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      searchDate.setText(dateFormat.format(new Date()));
    }
  }
);
  routingPanel.add(resetSearchDateButton);
  searchDate=new JTextField();
  searchDate.setText(dateFormat.format(new Date()));
  routingPanel.add(searchDate);
  walkCheckBox=new JCheckBox("walk");
  routingPanel.add(walkCheckBox);
  bikeCheckBox=new JCheckBox("bike");
  routingPanel.add(bikeCheckBox);
  trainCheckBox=new JCheckBox("trainish");
  routingPanel.add(trainCheckBox);
  busCheckBox=new JCheckBox("busish");
  routingPanel.add(busCheckBox);
  ferryCheckBox=new JCheckBox("ferry");
  routingPanel.add(ferryCheckBox);
  transitCheckBox=new JCheckBox("transit");
  routingPanel.add(transitCheckBox);
  JLabel boardPenaltyLabel=new JLabel("Boarding penalty (min):");
  routingPanel.add(boardPenaltyLabel);
  boardingPenaltyField=new JTextField("5");
  routingPanel.add(boardingPenaltyField);
  JButton routeButton=new JButton("path search");
  routeButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String from=sourceVertex.getText();
      String to=sinkVertex.getText();
      route(from,to);
    }
  }
);
  routingPanel.add(routeButton);
  JButton clearRouteButton=new JButton("clear path");
  clearRouteButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      showGraph.highlightGraphPath(null);
      showGraph.clearHighlights();
    }
  }
);
  routingPanel.add(clearRouteButton);
  JPanel vertexDataPanel=new JPanel();
  vertexDataPanel.setLayout(new BoxLayout(vertexDataPanel,BoxLayout.PAGE_AXIS));
  vertexDataPanel.setPreferredSize(new Dimension(300,600));
  leftPanel.add(vertexDataPanel,BorderLayout.CENTER);
  JLabel nvLabel=new JLabel("Vertices");
  vertexDataPanel.add(nvLabel);
  nearbyVertices=new JList();
  nearbyVertices.setVisibleRowCount(4);
  JScrollPane nvScrollPane=new JScrollPane(nearbyVertices);
  vertexDataPanel.add(nvScrollPane);
  JLabel ogeLabel=new JLabel("Outgoing edges");
  vertexDataPanel.add(ogeLabel);
  outgoingEdges=new JList();
  outgoingEdges.setVisibleRowCount(4);
  JScrollPane ogeScrollPane=new JScrollPane(outgoingEdges);
  vertexDataPanel.add(ogeScrollPane);
  JLabel iceLabel=new JLabel("Incoming edges");
  vertexDataPanel.add(iceLabel);
  incomingEdges=new JList();
  JScrollPane iceScrollPane=new JScrollPane(incomingEdges);
  vertexDataPanel.add(iceScrollPane);
  ListSelectionListener edgeChanged=new ListSelectionListener(){
    public void valueChanged(    ListSelectionEvent e){
      JList edgeList=(JList)e.getSource();
      DirectEdge selected=(DirectEdge)edgeList.getSelectedValue();
      if (selected == null) {
        departurePattern.removeAll();
        return;
      }
      showGraph.highlightEdge(selected);
      if (selected instanceof TurnEdge || selected instanceof PlainStreetEdge) {
        List<Vertex> vertices=new ArrayList<Vertex>();
        List<DirectEdge> edges=new ArrayList<DirectEdge>();
        Vertex tov=selected.getToVertex();
        for (        Edge og : graph.getOutgoing(tov)) {
          if (og instanceof TurnEdge || og instanceof PlainStreetEdge) {
            edges.add((DirectEdge)og);
            vertices.add(((StreetEdge)og).getToVertex());
            break;
          }
        }
        Vertex fromv=selected.getFromVertex();
        for (        Edge ic : graph.getIncoming(fromv)) {
          if (ic instanceof TurnEdge || ic instanceof PlainStreetEdge) {
            edges.add((DirectEdge)ic);
            vertices.add(ic.getFromVertex());
            break;
          }
        }
        showGraph.setHighlightedEdges(edges);
      }
      VertexList nearbyModel=(VertexList)nearbyVertices.getModel();
      List<Vertex> vertices=nearbyModel.selected;
      Vertex v;
      if (edgeList == outgoingEdges) {
        v=selected.getToVertex();
      }
 else {
        v=selected.getFromVertex();
      }
      if (!vertices.contains(v)) {
        vertices.add(v);
        nearbyModel=new VertexList(vertices);
        nearbyVertices.setModel(nearbyModel);
      }
      metadataModel.clear();
      Class<?> c=selected.getClass();
      Field[] fields;
      while (c != null && c != Object.class) {
        metadataModel.addElement("Class:" + c);
        fields=c.getDeclaredFields();
        for (int i=0; i < fields.length; i++) {
          Field field=fields[i];
          int modifiers=field.getModifiers();
          if ((modifiers & Modifier.STATIC) != 0) {
            continue;
          }
          field.setAccessible(true);
          String name=field.getName();
          String value="(unknown -- see console for stack trace)";
          try {
            value="" + field.get(selected);
          }
 catch (          IllegalArgumentException e1) {
            e1.printStackTrace();
          }
catch (          IllegalAccessException e1) {
            e1.printStackTrace();
          }
          metadataModel.addElement(name + ": " + value);
        }
        c=c.getSuperclass();
      }
      Vertex fromv=selected.getFromVertex();
      c=fromv.getClass();
      while (c != null && c != Object.class) {
        metadataModel.addElement("From vertex class:" + c);
        fields=c.getDeclaredFields();
        for (int i=0; i < fields.length; i++) {
          Field field=fields[i];
          int modifiers=field.getModifiers();
          if ((modifiers & Modifier.STATIC) != 0) {
            continue;
          }
          field.setAccessible(true);
          String name=field.getName();
          String value="(unknown -- see console for stack trace)";
          try {
            value="" + field.get(fromv);
          }
 catch (          IllegalArgumentException e1) {
            e1.printStackTrace();
          }
catch (          IllegalAccessException e1) {
            e1.printStackTrace();
          }
          metadataModel.addElement(name + ": " + value);
        }
        c=c.getSuperclass();
      }
      TripPattern pattern=null;
      int stopIndex=0;
      if (selected instanceof PatternBoard) {
        PatternBoard boardEdge=(PatternBoard)selected;
        pattern=boardEdge.getPattern();
        stopIndex=boardEdge.getStopIndex();
      }
 else       if (selected instanceof PatternAlight) {
        PatternAlight alightEdge=(PatternAlight)selected;
        pattern=alightEdge.getPattern();
        stopIndex=alightEdge.getStopIndex();
      }
 else {
        departurePattern.removeAll();
        return;
      }
      ListModel model=new TripPatternListModel(pattern,stopIndex);
      departurePattern.setModel(model);
      Trip trip=pattern.getExemplar();
      serviceIdLabel.setText(trip.getServiceId().toString());
    }
  }
;
  outgoingEdges.addListSelectionListener(edgeChanged);
  incomingEdges.addListSelectionListener(edgeChanged);
  nearbyVertices.addListSelectionListener(new ListSelectionListener(){
    public void valueChanged(    ListSelectionEvent e){
      outgoingEdges.removeAll();
      incomingEdges.removeAll();
      DisplayVertex selected=(DisplayVertex)nearbyVertices.getSelectedValue();
      if (selected != null) {
        Vertex nowSelected=selected.vertex;
        showGraph.highlightVertex(nowSelected);
        outgoingEdges.setModel(new EdgeListModel(graph.getOutgoing(nowSelected)));
        incomingEdges.setModel(new EdgeListModel(graph.getIncoming(nowSelected)));
      }
    }
  }
);
  JPanel buttonPanel=new JPanel();
  buttonPanel.setLayout(new GridLayout(0,3));
  leftPanel.add(buttonPanel,BorderLayout.PAGE_END);
  JButton zoomDefaultButton=new JButton("Zoom to default");
  zoomDefaultButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      showGraph.zoomToDefault();
    }
  }
);
  buttonPanel.add(zoomDefaultButton);
  final JFrame frame=this;
  JButton zoomToNodeButton=new JButton("Zoom to node");
  zoomToNodeButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String nodeName=(String)JOptionPane.showInputDialog(frame,"Node id",JOptionPane.PLAIN_MESSAGE);
      Vertex v=getGraph().getVertex(nodeName);
      if (v == null) {
        System.out.println("no such node " + nodeName);
      }
 else {
        showGraph.zoomToVertex(v);
      }
    }
  }
);
  buttonPanel.add(zoomToNodeButton);
  JButton zoomToLocationButton=new JButton("Zoom to location");
  zoomToLocationButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String result=JOptionPane.showInputDialog("Enter the location (lat lon)");
      if (result == null || result.length() == 0)       return;
      String[] tokens=result.split("[\\s,]+");
      double lat=Double.parseDouble(tokens[0]);
      double lon=Double.parseDouble(tokens[1]);
      Coordinate c=new Coordinate(lon,lat);
      showGraph.zoomToLocation(c);
    }
  }
);
  buttonPanel.add(zoomToLocationButton);
  JButton zoomOutButton=new JButton("Zoom out");
  zoomOutButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      showGraph.zoomOut();
    }
  }
);
  buttonPanel.add(zoomOutButton);
  JButton routeButton2=new JButton("Route");
  routeButton2.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String from=sourceVertex.getText();
      String to=sinkVertex.getText();
      route(from,to);
    }
  }
);
  buttonPanel.add(routeButton2);
  JButton findButton=new JButton("Find node");
  findButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String nodeName=(String)JOptionPane.showInputDialog(frame,"Node id",JOptionPane.PLAIN_MESSAGE);
      Vertex v=getGraph().getVertex(nodeName);
      if (v == null) {
        System.out.println("no such node " + nodeName);
      }
 else {
        showGraph.highlightVertex(v);
        ArrayList<Vertex> l=new ArrayList<Vertex>();
        l.add(v);
        verticesSelected(l);
      }
    }
  }
);
  buttonPanel.add(findButton);
  JButton findEdgeButton=new JButton("Find edge");
  findEdgeButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String edgeName=(String)JOptionPane.showInputDialog(frame,"Edge name like",JOptionPane.PLAIN_MESSAGE);
      for (      GraphVertex gv : getGraph().getVertices()) {
        for (        DirectEdge edge : filter(gv.getOutgoing(),DirectEdge.class)) {
          if (edge.getName() != null && edge.getName().contains(edgeName)) {
            showGraph.highlightVertex(gv.vertex);
            ArrayList<Vertex> l=new ArrayList<Vertex>();
            l.add(gv.vertex);
            verticesSelected(l);
          }
        }
      }
    }
  }
);
  buttonPanel.add(findEdgeButton);
  JButton checkButton=new JButton("Check graph");
  checkButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      checkGraph();
    }
  }
);
  buttonPanel.add(checkButton);
  JButton traceButton=new JButton("Trace");
  traceButton.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      trace();
    }
  }
);
  buttonPanel.add(traceButton);
  JPanel rightPanel=new JPanel();
  rightPanel.setLayout(new BorderLayout());
  pane.add(rightPanel,BorderLayout.LINE_END);
  JTabbedPane rightPanelTabs=new JTabbedPane();
  rightPanel.add(rightPanelTabs,BorderLayout.CENTER);
  serviceIdLabel=new JLabel("[service id]");
  rightPanel.add(serviceIdLabel,BorderLayout.PAGE_END);
  departurePattern=new JList();
  departurePattern.setPrototypeCellValue("Bite the wax tadpole right on the nose");
  JScrollPane dpScrollPane=new JScrollPane(departurePattern);
  rightPanelTabs.addTab("trip pattern",dpScrollPane);
  JList metadataList=new JList();
  metadataModel=new DefaultListModel();
  metadataList.setModel(metadataModel);
  metadataList.setPrototypeCellValue("bicycleSafetyEffectiveLength : 10.42468803");
  JScrollPane mdScrollPane=new JScrollPane(metadataList);
  rightPanelTabs.addTab("metadata",mdScrollPane);
  showGraph.init();
  addWindowListener(new ExitListener());
  pack();
}
