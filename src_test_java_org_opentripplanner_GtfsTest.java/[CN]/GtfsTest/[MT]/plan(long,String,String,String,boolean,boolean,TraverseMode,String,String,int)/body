{
  final TraverseMode mode=preferredMode != null ? preferredMode : TraverseMode.TRANSIT;
  RoutingRequest routingRequest=new RoutingRequest();
  routingRequest.setArriveBy(dateTime < 0);
  routingRequest.dateTime=Math.abs(dateTime);
  if (fromVertex != null && !fromVertex.isEmpty()) {
    routingRequest.setFrom(new GenericLocation(null,agencyId + "_" + fromVertex));
  }
  if (toVertex != null && !toVertex.isEmpty()) {
    routingRequest.setTo(new GenericLocation(null,agencyId + "_" + toVertex));
  }
  if (onTripId != null && !onTripId.isEmpty()) {
    routingRequest.setStartingTransitTripId(new AgencyAndId(agencyId,onTripId));
  }
  routingRequest.setRoutingContext(graph);
  routingRequest.setWheelchairAccessible(wheelchairAccessible);
  routingRequest.setTransferPenalty(preferLeastTransfers ? 300 : 0);
  routingRequest.setModes(new TraverseModeSet(TraverseMode.WALK,mode));
  if (excludedRoute != null && !excludedRoute.isEmpty()) {
    routingRequest.setBannedRoutes(agencyId + "__" + excludedRoute);
  }
  if (excludedStop != null && !excludedStop.isEmpty()) {
    routingRequest.setBannedStopsHard(agencyId + "_" + excludedStop);
  }
  routingRequest.setOtherThanPreferredRoutesPenalty(0);
  routingRequest.setWaitReluctance(1);
  routingRequest.setWalkBoardCost(30);
  TripPlan tripPlan=planGenerator.generate(routingRequest);
  itinerary=tripPlan.itinerary.get(0);
  assertEquals(legCount,itinerary.legs.size());
  return itinerary.legs.toArray(new Leg[legCount]);
}
