{
  Collection<SPTVertex> vertices=vertexSets.get(vertex);
  if (vertices == null) {
    vertices=new ArrayList<SPTVertex>();
    vertexSets.put(vertex,vertices);
    SPTVertex ret=new SPTVertex(vertex,state,weightSum,options);
    vertices.add(ret);
    return ret;
  }
  long time=state.getTime();
  Iterator<SPTVertex> it=vertices.iterator();
  if (options.getArriveBy()) {
    while (it.hasNext()) {
      SPTVertex v=it.next();
      double old_w=v.weightSum;
      long old_t=v.state.getTime();
      if (old_w <= weightSum && old_t >= time) {
        return null;
      }
      if (old_w > weightSum && old_t < time) {
        it.remove();
      }
    }
  }
 else {
    while (it.hasNext()) {
      SPTVertex v=it.next();
      double old_w=v.weightSum;
      long old_t=v.state.getTime();
      if (old_w <= weightSum && old_t <= time) {
        return null;
      }
      if (old_w > weightSum && old_t > time) {
        it.remove();
      }
    }
  }
  SPTVertex ret=new SPTVertex(vertex,state,weightSum,options);
  vertices.add(ret);
  return ret;
}
