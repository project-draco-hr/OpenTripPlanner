{
  stopsTouched.clear();
  for (int p=patternsTouched.nextSetBit(0); p >= 0; p=patternsTouched.nextSetBit(p + 1)) {
    int onTrip=-1;
    RaptorWorkerTimetable timetable=data.timetablesForPattern.get(p);
    int[] stops=data.stopsForPattern.get(p);
    int stopPositionInPattern=-1;
    for (    int stopIndex : stops) {
      stopPositionInPattern+=1;
      if (onTrip == -1) {
        if (bestTimes[stopIndex] == UNREACHED) {
          continue;
        }
        onTrip=timetable.findDepartureAfter(stopPositionInPattern,bestTimes[stopIndex]);
        continue;
      }
 else {
        int arrivalTime=timetable.getArrival(onTrip,stopPositionInPattern);
        if (arrivalTime < max_time && arrivalTime < bestNonTransferTimes[stopIndex]) {
          bestNonTransferTimes[stopIndex]=arrivalTime;
          if (arrivalTime < bestTimes[stopIndex])           bestTimes[stopIndex]=arrivalTime;
          stopsTouched.set(stopIndex);
        }
        while (onTrip > 0) {
          int departureOnPreviousTrip=timetable.getDeparture(onTrip - 1,stopPositionInPattern);
          if (departureOnPreviousTrip > bestNonTransferTimes[stopIndex]) {
            onTrip--;
          }
 else {
            break;
          }
        }
      }
    }
  }
  doTransfers();
  return !patternsTouched.isEmpty();
}
