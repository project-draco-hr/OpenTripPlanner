{
  State state=new State(options);
  for (int i=states.size() - 1; i >= 0; --i) {
    RaptorState cur=states.get(i);
    if (cur.walkPath != null) {
      GraphPath path=new GraphPath(cur.walkPath,true);
      for (      Edge e : path.edges) {
        State oldState=state;
        state=e.traverse(state);
        if (state == null) {
          e.traverse(oldState);
        }
      }
    }
 else {
      if (cur.getParent() == null || !cur.getParent().interlining) {
        for (        Edge e : state.getVertex().getOutgoing()) {
          if (e instanceof PreBoardEdge) {
            state=e.traverse(state);
            break;
          }
        }
        TransitBoardAlight board=cur.getRoute().boards[cur.boardStopSequence][cur.patternIndex];
        state=board.traverse(state);
      }
      HOP:       while (true) {
        for (        Edge e : state.getVertex().getOutgoing()) {
          if (e instanceof PatternDwell) {
            state=e.traverse(state);
          }
 else           if (e instanceof PatternHop) {
            state=e.traverse(state);
            if (cur.interlining) {
              for (              Edge e2 : state.getVertex().getOutgoing()) {
                RaptorState next=states.get(i - 1);
                if (e2 instanceof PatternInterlineDwell) {
                  if (((TransitVertex)e2.getToVertex()).getStop() == next.boardStop.stopVertex.getStop()) {
                    state=e2.traverse(state);
                    break HOP;
                  }
                }
              }
            }
            for (            Edge e2 : state.getVertex().getOutgoing()) {
              if (e2 instanceof TransitBoardAlight) {
                for (                Edge e3 : e2.getToVertex().getOutgoing()) {
                  if (e3 instanceof PreAlightEdge) {
                    if (data.raptorStopsForStopId.get(((TransitStop)e3.getToVertex()).getStopId()) == cur.stop) {
                      state=e2.traverse(state);
                      state=e3.traverse(state);
                      break HOP;
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  return state;
}
