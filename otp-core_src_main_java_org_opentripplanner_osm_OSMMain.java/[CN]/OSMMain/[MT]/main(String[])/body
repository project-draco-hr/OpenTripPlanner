{
  File dbFile=new File(DB);
  if (dbFile.exists()) {
    LOG.error("Target file already exists.");
    System.exit(0);
  }
  DB db=DBMaker.newFileDB(dbFile).transactionDisable().asyncWriteEnable().compressionEnable().make();
  LOG.info("Reading PBF file '{}'",INPUT);
  OSM osm=new OSM();
  osm.nodes=db.getTreeMap("nodes");
  osm.ways=db.getTreeMap("ways");
  osm.relations=db.getTreeMap("relations");
  try {
    Parser parser=new Parser(osm);
    FileInputStream input=new FileInputStream(INPUT);
    BlockInputStream bis=new BlockInputStream(input,parser);
    bis.process();
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
  LOG.info("Finding intersections.");
  Set<Long> referenced=db.getTreeSet("nodes_referenced");
  Set<Long> intersections=db.getTreeSet("nodes_intersections");
  for (  long wid : osm.ways.keySet()) {
    Way way=osm.ways.get(wid);
    for (    long nid : way.nodes) {
      if (referenced.contains(nid)) {
        intersections.add(nid);
      }
 else {
        referenced.add(nid);
      }
    }
  }
  LOG.info("Done finding intersections.");
  LOG.info("Making edges from Ways.");
  List<Edge> edges=Lists.newArrayList();
  for (  Entry<Long,Way> e : osm.ways.entrySet()) {
    Way way=e.getValue();
    Edge edge=new Edge();
    edge.way=e.getKey();
    edge.from=way.nodes[0];
    for (int n=1; n < way.nodes.length; n++) {
      long node=way.nodes[n];
      if (n == (way.nodes.length - 1)) {
        edge.to=node;
        edges.add(edge);
      }
 else       if (intersections.contains(node)) {
        edge.to=node;
        edges.add(edge);
        edge=new Edge();
        edge.way=e.getKey();
        edge.from=node;
      }
    }
  }
  LOG.info("Done making {} edges from {} ways.",edges.size(),osm.ways.size());
  db.close();
}
