{
  if (shapeId == null || shapeId.getId() == null || shapeId.getId().equals(""))   return null;
  double startDistance=st0.getShapeDistTraveled();
  double endDistance=st1.getShapeDistTraveled();
  boolean hasShapeDist=st0.isShapeDistTraveledSet() && st1.isShapeDistTraveledSet();
  if (hasShapeDist) {
    ShapeSegmentKey key=new ShapeSegmentKey(shapeId,startDistance,endDistance);
    LineString geometry=_geometriesByShapeSegmentKey.get(key);
    if (geometry != null)     return geometry;
    double[] distances=getDistanceForShapeId(shapeId);
    if (distances == null) {
      _log.warn(GraphBuilderAnnotation.register(graph,Variety.BOGUS_SHAPE_GEOMETRY,shapeId));
      return null;
    }
 else {
      LinearLocation startIndex=getSegmentFraction(distances,startDistance);
      LinearLocation endIndex=getSegmentFraction(distances,endDistance);
      if (equals(startIndex,endIndex)) {
        GraphBuilderAnnotation.register(graph,Variety.BOGUS_SHAPE_DIST_TRAVELED,st1);
        return createSimpleGeometry(st0.getStop(),st1.getStop());
      }
      LineString line=getLineStringForShapeId(shapeId);
      LocationIndexedLine lol=new LocationIndexedLine(line);
      geometry=getSegmentGeometry(graph,shapeId,lol,startIndex,endIndex,startDistance,endDistance,st0,st1);
      return geometry;
    }
  }
  LineString line=getLineStringForShapeId(shapeId);
  if (line == null) {
    _log.warn(GraphBuilderAnnotation.register(graph,Variety.BOGUS_SHAPE_GEOMETRY,shapeId));
    return null;
  }
  LocationIndexedLine lol=new LocationIndexedLine(line);
  LinearLocation startCoord=lol.indexOf(startJourney.getCoordinate());
  LinearLocation endCoord=lol.indexOf(endJourney.getCoordinate());
  double distanceFrom=startCoord.getSegmentLength(line);
  double distanceTo=endCoord.getSegmentLength(line);
  return getSegmentGeometry(graph,shapeId,lol,startCoord,endCoord,distanceFrom,distanceTo,st0,st1);
}
