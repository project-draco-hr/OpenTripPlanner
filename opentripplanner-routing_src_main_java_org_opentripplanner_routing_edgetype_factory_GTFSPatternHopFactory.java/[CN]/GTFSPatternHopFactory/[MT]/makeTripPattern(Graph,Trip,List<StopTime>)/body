{
  TripPattern tripPattern=new TripPattern(trip,stopTimes);
  TraverseMode mode=GtfsLibrary.getTraverseMode(trip.getRoute());
  boolean tripWheelchairAccessible=trip.getWheelchairAccessible() != 0;
  int lastStop=stopTimes.size() - 1;
  int departureTime=-1, prevDepartureTime=-1;
  int numInterpStops=-1, firstInterpStop=-1;
  int interpStep=0;
  int i;
  Stop s1=null;
  for (i=0; i < lastStop; i++) {
    StopTime st0=stopTimes.get(i);
    Stop s0=st0.getStop();
    StopTime st1=stopTimes.get(i + 1);
    s1=st1.getStop();
    int dwellTime=st0.getDepartureTime() - st0.getArrivalTime();
    Vertex startJourneyDepart=graph.addVertex(id(s0.getId()) + "_" + id(trip.getId())+ "_D",s0.getName(),s0.getId().getId(),s0.getLon(),s0.getLat());
    Vertex endJourneyArrive=graph.addVertex(id(s1.getId()) + "_" + id(trip.getId())+ "_A",s1.getName(),s1.getId().getId(),s1.getLon(),s1.getLat());
    Vertex startJourneyArrive;
    if (i != 0) {
      startJourneyArrive=graph.addVertex(id(s0.getId()) + "_" + id(trip.getId())+ "_A",s0.getName(),s0.getId().getId(),s0.getLon(),s0.getLat());
      PatternDwell dwell=new PatternDwell(startJourneyArrive,startJourneyDepart,i,tripPattern);
      if (dwellTime == 0) {
        potentiallyUselessDwells.add(dwell);
      }
      graph.addEdge(dwell);
    }
    PatternHop hop=new PatternHop(startJourneyDepart,endJourneyArrive,s0,s1,i,tripPattern);
    hop.setGeometry(getHopGeometry(trip.getShapeId(),st0,st1,startJourneyDepart,endJourneyArrive));
    prevDepartureTime=departureTime;
    departureTime=st0.getDepartureTime();
    int arrivalTime=st1.getArrivalTime();
    if (!(st0.isDepartureTimeSet() && st1.isArrivalTimeSet())) {
      if (numInterpStops == -1) {
        int j;
        for (j=i + 1; j < lastStop + 1; ++j) {
          StopTime st=stopTimes.get(j);
          if (st.isDepartureTimeSet()) {
            break;
          }
        }
        if (j == lastStop + 1) {
          throw new RuntimeException("Could not interpolate arrival/departure time on stop " + i + " on trip "+ trip);
        }
        StopTime st=stopTimes.get(j);
        numInterpStops=j - i - 1;
        firstInterpStop=i + 1;
        interpStep=(st.getArrivalTime() - departureTime) / (numInterpStops + 2);
      }
      if (i >= firstInterpStop) {
        departureTime=prevDepartureTime + interpStep * (i + 1 - firstInterpStop);
      }
      if (i < firstInterpStop + numInterpStops - 1) {
        arrivalTime=departureTime + interpStep;
      }
      if (i == firstInterpStop + numInterpStops - 1) {
        numInterpStops=-1;
      }
    }
    int runningTime=arrivalTime - departureTime;
    boolean stopWheelchairBoarding=s0.getWheelchairBoarding() != 0;
    tripPattern.addHop(i,0,departureTime,runningTime,arrivalTime,dwellTime,stopWheelchairBoarding && tripWheelchairAccessible,trip.getId());
    graph.addEdge(hop);
    Vertex startStation=graph.getVertex(id(s0.getId()));
    Vertex endStation=graph.getVertex(id(s1.getId()));
    PatternBoard boarding=new PatternBoard(startStation,startJourneyDepart,tripPattern,i,mode);
    graph.addEdge(boarding);
    graph.addEdge(new PatternAlight(endJourneyArrive,endStation,tripPattern,i,mode));
  }
  boolean stopWheelchairBoarding=s1.getWheelchairBoarding() != 0;
  tripPattern.setWheelchairAccessible(i,0,stopWheelchairBoarding && tripWheelchairAccessible);
  return tripPattern;
}
