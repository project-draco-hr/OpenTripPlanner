{
  BasicTripPattern tripPattern=new BasicTripPattern(trip,stopTimes);
  TraverseMode mode=GtfsLibrary.getTraverseMode(trip.getRoute());
  int lastStop=stopTimes.size() - 1;
  int i;
  StopTime st1=null;
  PatternArriveVertex psv0arrive, psv1arrive=null;
  PatternDepartVertex psv0depart;
  ArrayList<Edge> createdEdges=new ArrayList<Edge>();
  ArrayList<Vertex> createdVertices=new ArrayList<Vertex>();
  for (i=0; i < lastStop; i++) {
    StopTime st0=stopTimes.get(i);
    Stop s0=st0.getStop();
    st1=stopTimes.get(i + 1);
    Stop s1=st1.getStop();
    int arrivalTime=st1.getArrivalTime();
    int departureTime=st0.getDepartureTime();
    int dwellTime=st0.getDepartureTime() - st0.getArrivalTime();
    int runningTime=arrivalTime - departureTime;
    if (runningTime < 0) {
      _log.warn(GraphBuilderAnnotation.register(graph,Variety.NEGATIVE_HOP_TIME,st0,st1));
      for (      Edge e : createdEdges) {
        e.getFromVertex().removeOutgoing(e);
        e.getToVertex().removeIncoming(e);
      }
      for (      Vertex v : createdVertices) {
        graph.removeVertexAndEdges(v);
      }
      return null;
    }
    psv0depart=new PatternDepartVertex(graph,tripPattern,st0);
    createdVertices.add(psv0depart);
    context.patternDepartNodes.put(new T2<Stop,Trip>(s0,trip),psv0depart);
    if (i != 0) {
      psv0arrive=psv1arrive;
      PatternDwell dwell=new PatternDwell(psv0arrive,psv0depart,i,tripPattern);
      createdEdges.add(dwell);
      if (dwellTime == 0) {
        potentiallyUselessDwells.add(dwell);
      }
    }
    psv1arrive=new PatternArriveVertex(graph,tripPattern,st1);
    createdVertices.add(psv1arrive);
    context.patternArriveNodes.put(new T2<Stop,Trip>(s1,trip),psv1arrive);
    PatternHop hop=new PatternHop(psv0depart,psv1arrive,s0,s1,i,tripPattern);
    createdEdges.add(hop);
    hop.setGeometry(getHopGeometry(graph,trip.getShapeId(),st0,st1,psv0depart,psv1arrive));
    tripPattern.addHop(i,0,departureTime,runningTime,arrivalTime,dwellTime,st0.getStopHeadsign(),trip);
    TransitStopDepart stopDepart=context.stopDepartNodes.get(s0);
    TransitStopArrive stopArrive=context.stopArriveNodes.get(s1);
    Edge board=new PatternBoard(stopDepart,psv0depart,tripPattern,i,mode);
    Edge alight=new PatternAlight(psv1arrive,stopArrive,tripPattern,i,mode);
    createdEdges.add(board);
    createdEdges.add(alight);
  }
  tripPattern.setTripFlags(0,((trip.getWheelchairAccessible() == 1) ? TableTripPattern.FLAG_WHEELCHAIR_ACCESSIBLE : 0) | (((trip.getRoute().getBikesAllowed() == 2 && trip.getTripBikesAllowed() != 1) || trip.getTripBikesAllowed() == 2) ? TableTripPattern.FLAG_BIKES_ALLOWED : 0));
  return tripPattern;
}
