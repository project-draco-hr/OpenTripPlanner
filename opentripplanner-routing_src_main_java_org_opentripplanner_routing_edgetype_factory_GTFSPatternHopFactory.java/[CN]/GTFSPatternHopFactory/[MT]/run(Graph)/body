{
  ArrayList<Traversable> ret=new ArrayList<Traversable>();
  Collection<Trip> trips=_dao.getAllTrips();
  HashMap<StopPattern2,TripPattern> patterns=new HashMap<StopPattern2,TripPattern>();
  for (  Trip trip : trips) {
    List<StopTime> stopTimes=_dao.getStopTimesForTrip(trip);
    StopPattern2 stopPattern=stopPatternfromTrip(trip,_dao);
    TripPattern tripPattern=patterns.get(stopPattern);
    int lastStop=stopTimes.size() - 1;
    if (tripPattern == null) {
      tripPattern=new TripPattern(trip,stopTimes);
      for (int i=0; i < lastStop; i++) {
        StopTime st0=stopTimes.get(i);
        Stop s0=st0.getStop();
        StopTime st1=stopTimes.get(i + 1);
        Stop s1=st1.getStop();
        int runningTime=st1.getArrivalTime() - st0.getDepartureTime();
        PatternHop hop=new PatternHop(s0,s1,i,tripPattern);
        tripPattern.addHop(i,0,st0.getDepartureTime(),runningTime);
        ret.add(hop);
        Vertex startStation=graph.getVertex(id(s0.getId()));
        Vertex endStation=graph.getVertex(id(s1.getId()));
        Vertex startJourney=graph.addVertex(id(s0.getId()) + "_" + id(trip.getId()),s0.getLon(),s0.getLat());
        Vertex endJourney=graph.addVertex(id(s1.getId()) + "_" + id(trip.getId()),s1.getLon(),s1.getLat());
        PatternBoard boarding=new PatternBoard(tripPattern,i);
        graph.addEdge(startStation,startJourney,boarding);
        graph.addEdge(endJourney,endStation,new Alight());
        graph.addEdge(startJourney,endJourney,hop);
      }
      patterns.put(stopPattern,tripPattern);
    }
 else {
      int insertionPoint=tripPattern.getInsertionPoint(stopTimes.get(0).getDepartureTime());
      if (insertionPoint < 0) {
        _log.warn("duplicate first departure time for trip " + trip.getId() + ".  This will be handled correctly but inefficiently.");
        createSimpleHops(graph,trip,stopTimes);
      }
 else {
        for (int i=0; i < lastStop; i++) {
          StopTime st0=stopTimes.get(i);
          StopTime st1=stopTimes.get(i + 1);
          int runningTime=st1.getArrivalTime() - st0.getDepartureTime();
          try {
            tripPattern.addHop(i,insertionPoint,st0.getDepartureTime(),runningTime);
          }
 catch (          TripOvertakingException e) {
            _log.warn("trip " + trip.getId() + "overtakes another trip with the same stops.  This will be handled correctly but inefficiently.");
            for (; i >= 0; --i) {
              tripPattern.removeHop(i,insertionPoint);
            }
            createSimpleHops(graph,trip,stopTimes);
            break;
          }
        }
      }
    }
  }
  return ret;
}
