{
  LinkedList<State> states=path.states;
  Currency currency=null;
  List<Ride> rides=new ArrayList<Ride>();
  Ride newRide=null;
  for (  State curr : states) {
    EdgeNarrative edgeNarrative=curr.getBackEdgeNarrative();
    if (edgeNarrative == null)     continue;
    String zone=curr.getZone();
    AgencyAndId route=curr.getRoute();
    TraverseMode mode=edgeNarrative.getMode();
    if (zone == null && route == null) {
      newRide=null;
    }
 else {
      if (mode.isTransit() || mode == TraverseMode.BOARDING) {
        if (newRide == null || !route.equals(newRide.route)) {
          newRide=new Ride();
          rides.add(newRide);
          newRide.startZone=zone;
          newRide.route=route;
          newRide.startTime=curr.getTime();
        }
        newRide.zones.add(zone);
        newRide.endZone=zone;
        newRide.endTime=curr.getTime();
      }
    }
  }
  if (rides.size() == 0) {
    return null;
  }
  Set<String> zones=new HashSet<String>();
  Set<AgencyAndId> routes=new HashSet<AgencyAndId>();
  String startZone=null;
  int transfersUsed=-1;
  float totalFare=0, currentFare=-1;
  long startTime=rides.get(0).startTime;
  for (int i=0; i < rides.size(); ++i) {
    Ride ride=rides.get(i);
    if (startZone == null) {
      startZone=ride.startZone;
    }
    float bestFare=Float.MAX_VALUE;
    routes.add(ride.route);
    zones.addAll(ride.zones);
    transfersUsed+=1;
    long tripTime=ride.startTime - startTime;
    long journeyTime=ride.endTime - startTime;
    for (    AgencyAndId fareId : fareAttributes.keySet()) {
      FareRuleSet ruleSet=fareRules.get(fareId);
      if (ruleSet == null || ruleSet.matches(startZone,ride.endZone,zones,routes)) {
        FareAttribute attribute=fareAttributes.get(fareId);
        if (attribute.isTransfersSet() && attribute.getTransfers() < transfersUsed) {
          continue;
        }
        if (attribute.isTransferDurationSet() && tripTime > attribute.getTransferDuration()) {
          continue;
        }
        if (attribute.isJourneyDurationSet() && journeyTime > attribute.getJourneyDuration()) {
          continue;
        }
        float newFare=attribute.getPrice();
        if (newFare < bestFare) {
          bestFare=newFare;
          currency=Currency.getInstance(attribute.getCurrencyType());
        }
      }
    }
    if (bestFare == Float.MAX_VALUE) {
      if (currentFare == -1) {
        _log.warn("No fare for a perfectly good ride: " + ride);
        return null;
      }
      totalFare+=currentFare;
      currentFare=-1;
      transfersUsed=-1;
      --i;
      zones=new HashSet<String>();
      startZone=ride.startZone;
      routes=new HashSet<AgencyAndId>();
      startTime=ride.startTime;
    }
 else {
      currentFare=bestFare;
    }
  }
  totalFare+=currentFare;
  Fare fare=new Fare();
  fare.addFare(FareType.regular,new WrappedCurrency(currency),(int)Math.round(totalFare * Math.pow(10,currency.getDefaultFractionDigits())));
  return fare;
}
