{
  LOG.warn("BEGIN HOP GENERATION");
  if (fareServiceFactory == null) {
    fareServiceFactory=new DefaultFareServiceFactory();
  }
  fareServiceFactory.setDao(_dao);
  loadStops(graph);
  loadPathways(graph);
  loadAgencies(graph);
  clearCachedData();
  LOG.debug("building hops from trips");
  Collection<Trip> trips=_dao.getAllTrips();
  int tripCount=0;
  ListMultimap<Trip,Frequency> frequenciesForTrip=ArrayListMultimap.create();
  for (  Frequency freq : _dao.getAllFrequencies()) {
    frequenciesForTrip.put(freq.getTrip(),freq);
  }
  TRIP:   for (  Trip trip : trips) {
    if (++tripCount % 100000 == 0) {
      LOG.debug("trips=" + tripCount + "/"+ trips.size());
    }
    if (!_calendarService.getServiceIds().contains(trip.getServiceId())) {
      LOG.warn(graph.addBuilderAnnotation(new TripUndefinedService(trip)));
    }
    List<StopTime> stopTimes=_dao.getStopTimesForTrip(trip);
    if (removeRepeatedStops(stopTimes)) {
      LOG.warn(graph.addBuilderAnnotation(new RepeatedStops(trip)));
    }
    filterStopTimes(stopTimes,graph);
    interpolateStopTimes(stopTimes);
    if (stopTimes.size() < 2) {
      LOG.warn(graph.addBuilderAnnotation(new TripDegenerate(trip)));
      continue TRIP;
    }
    List<Frequency> frequencies=frequenciesForTrip.get(trip);
    if (frequencies != null && !frequencies.isEmpty()) {
      Collections.sort(frequencies,new Comparator<Frequency>(){
        @Override public int compare(        Frequency o1,        Frequency o2){
          return o1.getStartTime() - o2.getStartTime();
        }
      }
);
      Frequency frequency=frequencies.get(0);
      if (frequencies.size() > 1 || frequency.getStartTime() != stopTimes.get(0).getDepartureTime() || frequency.getEndTime() - frequency.getStartTime() > frequency.getHeadwaySecs()) {
        T2<FrequencyBasedTripPattern,List<FrequencyHop>> patternAndHops=makeFrequencyPattern(graph,trip,stopTimes);
        List<FrequencyHop> hops=patternAndHops.getSecond();
        FrequencyBasedTripPattern frequencyPattern=patternAndHops.getFirst();
        if (frequencyPattern != null)         frequencyPattern.createRanges(frequencies);
        createGeometry(graph,trip,stopTimes,hops);
        continue TRIP;
      }
    }
    StopPattern stopPattern=new StopPattern(stopTimes);
    TripTimes tripTimes=new TripTimes(trip,stopTimes);
    tripTimesForBlock.put(new BlockIdAndServiceId(trip),trip);
    TableTripPattern tableTripPattern=tableTripPatterns.get(stopPattern);
    if (tableTripPattern == null) {
      tableTripPattern=new TableTripPattern(trip.getRoute(),stopPattern);
      tableTripPatterns.put(stopPattern,tableTripPattern);
    }
    tableTripPattern.addTrip(trip,stopTimes);
  }
  for (  TableTripPattern tableTripPattern : tableTripPatterns.values()) {
    System.out.printf(" -- %s\n",tableTripPattern.getName());
  }
  TableTripPattern.generateUniqueNames(tableTripPatterns.values());
  for (  List<InterliningTrip> blockTrips : tripsForBlock.values()) {
    if (blockTrips.size() == 1) {
      continue;
    }
    Collections.sort(blockTrips);
    for (int i=0; i < blockTrips.size() - 1; ++i) {
      InterliningTrip fromInterlineTrip=blockTrips.get(i);
      InterliningTrip toInterlineTrip=blockTrips.get(i + 1);
      Trip fromTrip=fromInterlineTrip.trip;
      Trip toTrip=toInterlineTrip.trip;
      StopTime st0=fromInterlineTrip.lastStopTime;
      StopTime st1=toInterlineTrip.firstStopTime;
      Stop s0=st0.getStop();
      Stop s1=st1.getStop();
      if (st0.getPickupType() == 1) {
        continue;
      }
      Trip fromExemplar=fromInterlineTrip.tripPattern.exemplar;
      Trip toExemplar=toInterlineTrip.tripPattern.exemplar;
      InterlineSwitchoverKey dwellKey=new InterlineSwitchoverKey(s0,s1,fromInterlineTrip.tripPattern,toInterlineTrip.tripPattern);
      PatternInterlineDwell dwell=getInterlineDwell(dwellKey);
      if (dwell == null) {
        Vertex startJourney=context.patternArriveNodes.get(new T2<Stop,Trip>(s0,fromExemplar));
        Vertex endJourney=context.patternDepartNodes.get(new T2<Stop,Trip>(s1,toExemplar));
        dwell=new PatternInterlineDwell(startJourney,endJourney,toTrip);
        interlineDwells.put(dwellKey,dwell);
      }
      int dwellTime=st1.getDepartureTime() - st0.getArrivalTime();
      dwell.addTrip(fromTrip,toTrip,dwellTime,fromInterlineTrip.getPatternIndex(),toInterlineTrip.getPatternIndex());
    }
  }
  loadTransfers(graph);
  if (_deleteUselessDwells)   deleteUselessDwells(graph);
  clearCachedData();
  graph.putService(FareService.class,fareServiceFactory.makeFareService());
  graph.putService(ServiceIdToNumberService.class,new ServiceIdToNumberService(context.serviceIds));
  graph.putService(OnBoardDepartService.class,new OnBoardDepartServiceImpl());
  LOG.warn("END HOP GENERATION");
}
