{
  long now=System.currentTimeMillis();
  TIntLongIterator invisibleIterator=invisibleUntil.iterator();
  int nRedelivered=0;
  while (invisibleIterator.hasNext()) {
    invisibleIterator.advance();
    int taskId=invisibleIterator.key();
    long timeout=invisibleIterator.value();
    if (now > timeout) {
      invisibleIterator.remove();
      visibleTasks.add(tasksById.get(taskId));
      LOG.warn("Task {} was not completed in time, queueing it for re-delivery.",taskId);
      nRedelivered+=1;
    }
  }
  return nRedelivered;
}
