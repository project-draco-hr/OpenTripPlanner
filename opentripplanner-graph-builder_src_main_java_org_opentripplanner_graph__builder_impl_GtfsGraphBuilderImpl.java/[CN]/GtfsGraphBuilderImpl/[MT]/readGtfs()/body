{
  StoreImpl store=new StoreImpl();
  EntityHandler counter=new EntityCounter();
  store.open();
  for (  GtfsBundle gtfsBundle : _gtfsBundles.getBundles()) {
    _log.info("reading {}",gtfsBundle.toString());
    GtfsReader reader=new GtfsReader();
    reader.setInputSource(gtfsBundle.getCsvInputSource());
    reader.setEntityStore(store);
    reader.setInternStrings(true);
    if (gtfsBundle.getDefaultAgencyId() != null)     reader.setDefaultAgencyId(gtfsBundle.getDefaultAgencyId());
    for (    Map.Entry<String,String> entry : gtfsBundle.getAgencyIdMappings().entrySet())     reader.addAgencyIdMapping(entry.getKey(),entry.getValue());
    if (_log.isDebugEnabled())     reader.addEntityHandler(counter);
    if (gtfsBundle.getDefaultBikesAllowed())     reader.addEntityHandler(new EntityBikeability(true));
    for (    Class<?> entityClass : reader.getEntityClasses()) {
      _log.info("reading entities: " + entityClass.getName());
      reader.readEntities(entityClass);
      store.flush();
    }
  }
  store.close();
}
