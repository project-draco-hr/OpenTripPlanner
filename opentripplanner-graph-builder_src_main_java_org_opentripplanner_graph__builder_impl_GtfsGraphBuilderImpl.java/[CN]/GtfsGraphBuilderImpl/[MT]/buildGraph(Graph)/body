{
  try {
    readGtfs();
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  CalendarServiceDataFactoryImpl factory=new CalendarServiceDataFactoryImpl();
  factory.setGtfsDao(_dao);
  CalendarServiceData data=factory.createData();
  CalendarServiceImpl service=new CalendarServiceImpl();
  service.setData(data);
  GtfsContext context=GtfsLibrary.createContext(_dao,service);
  for (  Stop stop : _dao.getAllStops()) {
    String id=GtfsLibrary.convertIdToString(stop.getId());
    graph.addVertex(new TransitStop(id,stop.getLon(),stop.getLat(),stop.getName(),stop.getId(),stop));
  }
  GTFSPatternHopFactory hf=new GTFSPatternHopFactory(context);
  hf.run(graph);
  graph.putService(CalendarServiceData.class,data);
  graph.updateTransitFeedValidity(data);
  if (gtfsGraphBuilders != null) {
    for (    GraphBuilderWithGtfsDao builder : gtfsGraphBuilders) {
      builder.setDao(_dao);
      builder.buildGraph(graph);
      builder.setDao(null);
    }
  }
  if (_dao instanceof GtfsRelationalDaoImpl)   _dao=new GtfsRelationalDaoImpl();
}
