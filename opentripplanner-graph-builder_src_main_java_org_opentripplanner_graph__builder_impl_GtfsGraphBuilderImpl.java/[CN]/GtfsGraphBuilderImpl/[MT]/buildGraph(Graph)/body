{
  try {
    readGtfs();
    CalendarServiceDataFactoryImpl factory=new CalendarServiceDataFactoryImpl();
    factory.setGtfsDao(_dao);
    CalendarServiceData data=factory.createServiceCalendarData();
    CalendarServiceImpl service=new CalendarServiceImpl();
    service.setServiceCalendarData(data);
    GtfsContext context=GtfsLibrary.createContext(_dao,service);
    for (    Stop stop : _dao.getAllStops()) {
      String id=GtfsLibrary.convertIdToString(stop.getId());
      Vertex vertex=graph.addVertex(new GenericVertex(id,stop.getLon(),stop.getLat(),stop.getName()));
      vertex.setType(TransitStop.class);
    }
    GTFSPatternHopFactory hf=new GTFSPatternHopFactory(context);
    hf.run(graph);
    graph.putService(CalendarServiceData.class,data);
  }
 catch (  Exception ex) {
    throw new IllegalStateException("error building graph from gtfs",ex);
  }
}
