{
  if (dirty == null) {
    throw new ConcurrentModificationException("This TimetableSnapshot is read-only.");
  }
  TimetableSnapshot ret=new TimetableSnapshot();
  if (!force && !this.isDirty())   return null;
  for (  Timetable tt : dirty) {
    tt.finish();
  }
  ret.timetables=(HashMap<TripPattern,SortedSet<Timetable>>)this.timetables.clone();
  ret.lastAddedTripPattern=(HashMap<TripIdAndServiceDate,TripPattern>)this.lastAddedTripPattern.clone();
  this.dirty.clear();
  ret.dirty=null;
  return ret;
}
