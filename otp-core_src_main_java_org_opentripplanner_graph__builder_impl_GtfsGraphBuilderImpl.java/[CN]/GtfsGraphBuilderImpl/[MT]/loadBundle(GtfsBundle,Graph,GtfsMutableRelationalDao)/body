{
  StoreImpl store=new StoreImpl(dao);
  store.open();
  LOG.info("reading {}",gtfsBundle.toString());
  GtfsReader reader=new GtfsReader();
  reader.setInputSource(gtfsBundle.getCsvInputSource());
  reader.setEntityStore(store);
  reader.setInternStrings(true);
  if (gtfsBundle.getDefaultAgencyId() != null)   reader.setDefaultAgencyId(gtfsBundle.getDefaultAgencyId());
  for (  Map.Entry<String,String> entry : gtfsBundle.getAgencyIdMappings().entrySet())   reader.addAgencyIdMapping(entry.getKey(),entry.getValue());
  if (LOG.isDebugEnabled())   reader.addEntityHandler(counter);
  if (gtfsBundle.getDefaultBikesAllowed())   reader.addEntityHandler(new EntityBikeability(true));
  for (  Class<?> entityClass : reader.getEntityClasses()) {
    LOG.info("reading entities: " + entityClass.getName());
    reader.readEntities(entityClass);
    store.flush();
    if (entityClass == Agency.class) {
      if (reader.getDefaultAgencyId() == null) {
        reader.setDefaultAgencyId(reader.getAgencies().get(0).getId());
      }
      for (      Agency agency : reader.getAgencies()) {
        GtfsBundle existing=agenciesSeen.get(agency);
        if (existing != null) {
          LOG.warn(graph.addBuilderAnnotation(new AgencyNameCollision(agency,existing.toString())));
        }
 else {
          agenciesSeen.put(agency,gtfsBundle);
        }
      }
    }
  }
  for (  ShapePoint shapePoint : store.getAllEntitiesForType(ShapePoint.class)) {
    shapePoint.getShapeId().setAgencyId(reader.getDefaultAgencyId());
  }
  for (  Route route : store.getAllEntitiesForType(Route.class)) {
    route.getId().setAgencyId(reader.getDefaultAgencyId());
  }
  for (  Stop stop : store.getAllEntitiesForType(Stop.class)) {
    stop.getId().setAgencyId(reader.getDefaultAgencyId());
  }
  for (  Trip trip : store.getAllEntitiesForType(Trip.class)) {
    trip.getId().setAgencyId(reader.getDefaultAgencyId());
  }
  for (  ServiceCalendar serviceCalendar : store.getAllEntitiesForType(ServiceCalendar.class)) {
    serviceCalendar.getServiceId().setAgencyId(reader.getDefaultAgencyId());
  }
  for (  ServiceCalendarDate serviceCalendarDate : store.getAllEntitiesForType(ServiceCalendarDate.class)) {
    serviceCalendarDate.getServiceId().setAgencyId(reader.getDefaultAgencyId());
  }
  for (  FareAttribute fareAttribute : store.getAllEntitiesForType(FareAttribute.class)) {
    fareAttribute.getId().setAgencyId(reader.getDefaultAgencyId());
  }
  for (  Pathway pathway : store.getAllEntitiesForType(Pathway.class)) {
    pathway.getId().setAgencyId(reader.getDefaultAgencyId());
  }
  store.close();
}
