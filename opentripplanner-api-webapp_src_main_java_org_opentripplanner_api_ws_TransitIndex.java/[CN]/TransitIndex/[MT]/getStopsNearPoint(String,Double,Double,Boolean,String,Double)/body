{
  Double searchRadius=(radius == null) ? STOP_SEARCH_RADIUS : radius;
  Graph graph=getGraph(routerId);
  if (Double.isNaN(searchRadius) || searchRadius <= 0) {
    searchRadius=STOP_SEARCH_RADIUS;
  }
  StreetVertexIndexService streetVertexIndexService=graph.streetIndex;
  List<TransitStop> stops=streetVertexIndexService.getNearbyTransitStops(new Coordinate(lon,lat),searchRadius);
  TransitIndexService transitIndexService=graph.getService(TransitIndexService.class);
  if (transitIndexService == null) {
    return new TransitError("No transit index found.  Add TransitIndexBuilder to your graph builder configuration and rebuild your graph.");
  }
  StopList response=new StopList();
  for (  TransitStop transitStop : stops) {
    AgencyAndId stopId=transitStop.getStopId();
    if (agency != null && !agency.equals(stopId.getAgencyId()))     continue;
    StopType stop=new StopType(transitStop.getStop(),extended);
    stop.routes=transitIndexService.getRoutesForStop(stopId);
    response.stops.add(stop);
  }
  return response;
}
