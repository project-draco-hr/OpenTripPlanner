{
  Graph graph=getGraph(routerId);
  StreetVertexIndexService streetVertexIndexService=graph.streetIndex;
  List<TransitStop> stops=streetVertexIndexService.getNearbyTransitStops(new Coordinate(lon,lat),STOP_SEARCH_RADIUS);
  TransitIndexService transitIndexService=graph.getService(TransitIndexService.class);
  if (transitIndexService == null) {
    return new TransitError("No transit index found.  Add TransitIndexBuilder to your graph builder configuration and rebuild your graph.");
  }
  StopList response=new StopList();
  for (  TransitStop transitStop : stops) {
    AgencyAndId stopId=transitStop.getStopId();
    if (agency != null && !agency.equals(stopId.getAgencyId()))     continue;
    Stop stop=new Stop();
    stop.id=stopId;
    stop.lat=transitStop.getY();
    stop.lon=transitStop.getX();
    stop.stopCode=transitStop.getStopCode();
    stop.stopName=transitStop.getName();
    stop.routes=transitIndexService.getRoutesForStop(stopId);
    response.stops.add(stop);
  }
  return response;
}
