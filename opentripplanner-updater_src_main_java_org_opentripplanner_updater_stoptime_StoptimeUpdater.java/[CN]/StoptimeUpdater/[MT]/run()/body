{
  TimetableSnapshot buffer=snapshot;
  while (true) {
    UpdateList updates=updateStreamer.getUpdates();
    if (updates == null)     continue;
    for (    UpdateList ul : updates.splitByTrip()) {
      LOG.trace(ul.toString());
      if (!ul.isSane()) {
        LOG.trace("incoherent stoptime UpdateList");
        continue;
      }
      TableTripPattern pattern=patternIndex.get(ul.tripId);
      if (pattern == null) {
        LOG.trace("pattern not found {}",ul.tripId);
        continue;
      }
      if (buffer == snapshot) {
        buffer=snapshot.mutableCopy();
      }
      Timetable tt=buffer.modify(pattern);
      tt.update(ul);
    }
    if (buffer != snapshot) {
      long now=System.currentTimeMillis();
      if (now - lastSnapshotTime > maxSnapshotFrequency) {
        LOG.debug("committing {}",buffer.toString());
        buffer.commit();
        snapshot=buffer;
        graph.timetableSnapshot=snapshot;
        lastSnapshotTime=now;
      }
    }
  }
}
