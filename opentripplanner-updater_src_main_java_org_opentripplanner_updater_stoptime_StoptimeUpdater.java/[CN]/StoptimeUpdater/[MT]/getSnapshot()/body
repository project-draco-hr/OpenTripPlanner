{
  long now=System.currentTimeMillis();
  if (now - lastSnapshotTime > maxSnapshotFrequency) {
    if (buffer.isDirty()) {
      LOG.debug("Committing {}",buffer.toString());
      snapshot=buffer.commit();
    }
 else {
      LOG.debug("Buffer was unchanged, keeping old snapshot.");
    }
    lastSnapshotTime=System.currentTimeMillis();
  }
 else {
    LOG.debug("Snapshot frequency exceeded. Reusing snapshot {}",snapshot.toString());
  }
  return snapshot;
}
