{
  GraphService graphService=new GraphService(params.autoReload);
  this.graphService=graphService;
  InputStreamGraphSource.FileFactory graphSourceFactory=new InputStreamGraphSource.FileFactory(params.graphDirectory);
  graphService.graphSourceFactory=graphSourceFactory;
  graphService.routerLifecycleManager=routerLifecycleManager;
  if (params.graphDirectory != null) {
    graphSourceFactory.basePath=params.graphDirectory;
  }
  if (graph != null && (params.inMemory || params.preFlight)) {
    try {
      FileInputStream graphConfigurationStream=new FileInputStream(params.graphConfigFile);
      ObjectMapper mapper=new ObjectMapper();
      mapper.configure(JsonParser.Feature.ALLOW_COMMENTS,true);
      mapper.configure(JsonParser.Feature.ALLOW_UNQUOTED_FIELD_NAMES,true);
      JsonNode config=mapper.readTree(graphConfigurationStream);
      this.graphService.registerGraph("",new MemoryGraphSource("",graph,config));
    }
 catch (    Exception e) {
      if (params.graphConfigFile != null)       LOG.error("Can't read config file",e);
      this.graphService.registerGraph("",new MemoryGraphSource("",graph));
    }
  }
  if ((params.routerIds != null && params.routerIds.size() > 0) || params.autoScan) {
    GraphScanner graphScanner=new GraphScanner(graphService,params.graphDirectory,params.autoScan);
    graphScanner.basePath=graphSourceFactory.basePath;
    if (params.routerIds.size() > 0) {
      graphScanner.defaultRouterId=params.routerIds.get(0);
    }
    graphScanner.autoRegister=params.routerIds;
    graphScanner.startup();
  }
}
