{
  GraphServiceImpl graphService=new GraphServiceImpl(params.autoReload);
  this.graphService=graphService;
  InputStreamGraphSource.FileFactory graphSourceFactory=new InputStreamGraphSource.FileFactory(params.graphDirectory);
  graphService.graphSourceFactory=graphSourceFactory;
  if (params.graphDirectory != null) {
    graphSourceFactory.basePath=params.graphDirectory;
  }
  if (graph != null && (params.inMemory || params.preFlight)) {
    try {
      FileInputStream graphConfiguration=new FileInputStream(params.graphConfigFile);
      Preferences config=new PropertiesPreferences(graphConfiguration);
      this.graphService.registerGraph("",new MemoryGraphSource("",graph,config));
    }
 catch (    Exception e) {
      if (params.graphConfigFile != null)       LOG.error("Can't read config file",e);
      this.graphService.registerGraph("",new MemoryGraphSource("",graph));
    }
  }
  if (params.routerIds.size() > 0 || params.autoScan) {
    GraphScanner graphScanner=new GraphScanner(graphService,params.graphDirectory,params.autoScan);
    graphScanner.basePath=graphSourceFactory.basePath;
    if (params.routerIds.size() > 0) {
      graphScanner.defaultRouterId=params.routerIds.get(0);
    }
    graphScanner.autoRegister=params.routerIds;
    graphScanner.startup();
  }
}
