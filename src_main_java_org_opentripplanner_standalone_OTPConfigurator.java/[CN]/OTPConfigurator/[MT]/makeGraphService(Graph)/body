{
  if (graph != null && (params.inMemory || params.preFlight)) {
    try {
      FileInputStream graphConfiguration=new FileInputStream(params.graphConfigFile);
      Preferences config=new PropertiesPreferences(graphConfiguration);
      this.graphService=new GraphServiceBeanImpl(graph,config);
    }
 catch (    Exception e) {
      if (params.graphConfigFile != null)       LOG.error("Can't read config file",e);
      this.graphService=new GraphServiceBeanImpl(graph,null);
    }
  }
 else {
    GraphServiceImpl graphService=new GraphServiceImpl(true);
    FileGraphSourceFactory graphSourceFactory=new FileGraphSourceFactory();
    graphService.graphSourceFactory=graphSourceFactory;
    if (params.graphDirectory != null) {
      graphSourceFactory.basePath=new File(params.graphDirectory);
    }
    if (params.routerIds.size() > 0 || params.autoScan) {
      GraphScanner graphScanner=new GraphScanner(graphService,params.autoScan);
      graphScanner.basePath=graphSourceFactory.basePath;
      if (params.routerIds.size() > 0) {
        graphScanner.defaultRouterId=params.routerIds.get(0);
      }
      graphScanner.autoRegister=params.routerIds;
      graphScanner.startup();
    }
    this.graphService=graphService;
  }
}
