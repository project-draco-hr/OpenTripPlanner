{
  Date targetTime=new Date(origin.getTime() * 1000);
  TraverseOptions options=origin.getOptions();
  if (_graphService.getCalendarService() != null)   options.setCalendarService(_graphService.getCalendarService());
  options.setTransferTable(_graphService.getGraph().getTransferTable());
  options.setServiceDays(targetTime.getTime() / 1000,_graphService.getGraph().getAgencyIds());
  if (options.getModes().getTransit() && !_graphService.getGraph().transitFeedCovers(targetTime)) {
    throw new TransitTimesException();
  }
  options.remainingWeightHeuristic=_remainingWeightHeuristicFactory.getInstanceForSearch(options,target);
  LOG.debug("Applied A* heuristic: {}",options.remainingWeightHeuristic);
  if (!options.getModes().getTransit()) {
    nItineraries=1;
    options.setMaxWalkDistance(Double.MAX_VALUE);
  }
  ArrayList<GraphPath> paths=new ArrayList<GraphPath>();
  long searchBeginTime=System.currentTimeMillis();
  long abortFirst=_firstPathTimeout <= 0 ? 0 : (long)(searchBeginTime + _firstPathTimeout * 1000);
  long abortMulti=_multiPathTimeout <= 0 ? 0 : (long)(searchBeginTime + _multiPathTimeout * 1000);
  Queue<TraverseOptions> optionQueue=new LinkedList<TraverseOptions>();
  optionQueue.add(options);
  if (options.getModes().getTrainish() && options.getModes().contains(TraverseMode.BUS)) {
    TraverseOptions busOnly=options.clone();
    busOnly.setModes(options.getModes().clone());
    busOnly.getModes().setTrainish(false);
  }
  double maxWeight=Double.MAX_VALUE;
  double maxWalk=options.getMaxWalkDistance();
  long maxTime=options.isArriveBy() ? 0 : Long.MAX_VALUE;
  while (paths.size() < nItineraries) {
    options=optionQueue.poll();
    if (options == null) {
      LOG.debug("Ran out of options to try.");
      break;
    }
    options.setMaxWalkDistance(maxWalk);
    StateEditor editor=new StateEditor(origin,null);
    editor.setTraverseOptions(options);
    origin=editor.makeState();
    options.searchAbortTime=paths.isEmpty() ? abortFirst : abortMulti;
    options.maxComputationTime=0;
    options.maxWeight=maxWeight;
    long subsearchBeginTime=System.currentTimeMillis();
    LOG.debug("BEGIN SUBSEARCH");
    List<GraphPath> somePaths=_routingService.route(origin,target);
    LOG.debug("END SUBSEARCH ({} msec of {} msec total)",System.currentTimeMillis() - subsearchBeginTime,System.currentTimeMillis() - searchBeginTime);
    if (somePaths == null) {
      LOG.warn("Aborting search. {} paths found, elapsed time {} sec",paths.size(),(System.currentTimeMillis() - searchBeginTime) / 1000.0);
      break;
    }
    if (maxWeight == Double.MAX_VALUE) {
      if (somePaths.isEmpty()) {
        return null;
      }
      GraphPath path=somePaths.get(0);
      long duration=path.getDuration();
      LOG.debug("Setting max time and weight for subsequent searches.");
      LOG.debug("First path start time:  {}",path.getStartTime());
      maxTime=path.getStartTime() + MAX_TIME_FACTOR * (options.isArriveBy() ? -duration : duration);
      LOG.debug("First path duration:  {}",duration);
      LOG.debug("Max time set to:  {}",maxTime);
      maxWeight=path.getWeight() * MAX_WEIGHT_FACTOR;
      LOG.debug("Max weight set to:  {}",maxWeight);
      if (path.getWalkDistance() > maxWalk) {
        maxWalk=path.getWalkDistance() * 1.25;
      }
    }
    if (somePaths.isEmpty()) {
      LOG.debug("No paths were found.");
      continue;
    }
    for (    GraphPath path : somePaths) {
      if (!paths.contains(path)) {
        if (path.getWalkDistance() > maxWalk) {
          maxWalk=path.getWalkDistance() * 1.25;
        }
        paths.add(path);
        LOG.debug("New trips: {}",path.getTrips());
        TraverseOptions newOptions=options.clone();
        for (        AgencyAndId trip : path.getTrips()) {
          newOptions.bannedTrips.add(trip);
        }
        if (!optionQueue.contains(newOptions)) {
          optionQueue.add(newOptions);
        }
      }
    }
    LOG.debug("{} / {} itineraries",paths.size(),nItineraries);
  }
  if (paths.size() == 0) {
    return null;
  }
  Collections.sort(paths,new PathComparator(origin.getOptions().isArriveBy()));
  return paths;
}
