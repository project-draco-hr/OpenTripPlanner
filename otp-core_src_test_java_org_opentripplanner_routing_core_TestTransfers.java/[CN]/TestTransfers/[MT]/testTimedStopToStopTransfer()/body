{
  ServiceDate serviceDate=new ServiceDate(2009,07,11);
  TransferTable table=new TransferTable();
  when(graph.getTransferTable()).thenReturn(table);
  @SuppressWarnings("deprecation") Vertex origin=graph.getVertex("agency_N");
  @SuppressWarnings("deprecation") Vertex destination=graph.getVertex("agency_H");
  RoutingRequest options=new RoutingRequest();
  options.dateTime=TestUtils.dateInSeconds("America/New_York",2009,7,11,11,11,0);
  options.setRoutingContext(graph,origin,destination);
  GraphPath path;
  List<Trip> trips;
  path=planJourney(options);
  trips=extractTrips(path);
  assertEquals("8.1",trips.get(0).getId().getId());
  assertEquals("4.2",trips.get(1).getId().getId());
  Stop stopK=new Stop();
  stopK.setId(new AgencyAndId("agency","K"));
  Stop stopF=new Stop();
  stopF.setId(new AgencyAndId("agency","F"));
  table.addTransferTime(stopK,stopF,null,null,null,null,StopTransfer.TIMED_TRANSFER);
  @SuppressWarnings("deprecation") Vertex fromVertex=graph.getVertex("agency_K_arrive");
  @SuppressWarnings("deprecation") Vertex toVertex=graph.getVertex("agency_F_depart");
  TimedTransferEdge timedTransferEdge=new TimedTransferEdge(fromVertex,toVertex);
  path=planJourney(options);
  trips=extractTrips(path);
  assertEquals("8.1",trips.get(0).getId().getId());
  assertEquals("4.2",trips.get(1).getId().getId());
  @SuppressWarnings("deprecation") TableTripPattern pattern=((PatternStopVertex)graph.getVertex("agency_F_agency_4.3_1_D")).getTripPattern();
  applyUpdateToTripPattern(pattern,"4.2","F",1,55200,55200,ScheduleRelationship.SCHEDULED,0,serviceDate);
  path=planJourney(options);
  trips=extractTrips(path);
  assertEquals("8.1",trips.get(0).getId().getId());
  assertEquals("4.2",trips.get(1).getId().getId());
  applyUpdateToTripPattern(pattern,"4.2","F",1,55199,55199,ScheduleRelationship.SCHEDULED,0,serviceDate);
  path=planJourney(options);
  trips=extractTrips(path);
  assertEquals("8.1",trips.get(0).getId().getId());
  assertEquals("4.3",trips.get(1).getId().getId());
  applyUpdateToTripPattern(pattern,"4.2","F",1,82800,82800,ScheduleRelationship.SCHEDULED,0,serviceDate);
  timedTransferEdge.detach();
  reset(graph);
}
