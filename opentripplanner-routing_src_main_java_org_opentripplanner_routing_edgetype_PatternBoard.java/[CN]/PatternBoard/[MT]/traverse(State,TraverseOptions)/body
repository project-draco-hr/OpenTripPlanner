{
  if (!options.getModes().get(modeMask)) {
    return null;
  }
  long current_time=state0.getTime();
  long transfer_penalty=0;
  if (state0.lastAlightedTime != 0) {
    TransferTable transferTable=options.getTransferTable();
    if (transferTable.hasPreferredTransfers()) {
      transfer_penalty=options.baseTransferPenalty;
    }
    int transfer_time=transferTable.getTransferTime(state0.previousStop,getFromVertex());
    if (transfer_time == TransferTable.UNKNOWN_TRANSFER) {
      transfer_time=options.minTransferTime;
    }
    if (transfer_time > 0 && transfer_time > (current_time - state0.lastAlightedTime) * 1000) {
      current_time+=state0.lastAlightedTime + transfer_time * 1000;
    }
 else     if (transfer_time == TransferTable.FORBIDDEN_TRANSFER) {
      return null;
    }
 else     if (transfer_time == TransferTable.PREFERRED_TRANSFER) {
      transfer_penalty=0;
    }
  }
  ServiceDate service_date=getServiceDate(current_time,options.calendar);
  ServiceDate service_date_yesterday=getServiceDate(current_time - MILLI_IN_DAY,options.calendar);
  int seconds_since_midnight=(int)((current_time - service_date.getAsDate().getTime()) / 1000);
  int wait=-1;
  int patternIndex=-1;
  AgencyAndId service=getPattern().getExemplar().getServiceId();
  if (options.serviceOn(service,service_date)) {
    patternIndex=getPattern().getNextTrip(stopIndex,seconds_since_midnight,options.wheelchairAccessible,true);
    if (patternIndex >= 0) {
      wait=getPattern().getDepartureTime(stopIndex,patternIndex) - seconds_since_midnight;
    }
  }
  if (options.serviceOn(service,service_date_yesterday)) {
    int yesterday_pattern_index=getPattern().getNextTrip(stopIndex,seconds_since_midnight + SEC_IN_DAY,options.wheelchairAccessible,true);
    if (yesterday_pattern_index >= 0) {
      int wait_yesterday=getPattern().getDepartureTime(stopIndex,yesterday_pattern_index) - seconds_since_midnight - SEC_IN_DAY;
      if (wait < 0 || wait_yesterday < wait) {
        wait=wait_yesterday;
        patternIndex=yesterday_pattern_index;
      }
    }
  }
  if (wait < 0) {
    return null;
  }
  State state1=state0.clone();
  state1.setPattern(patternIndex);
  state1.incrementTimeInSeconds(wait);
  state1.numBoardings+=1;
  Trip trip=getPattern().getTrip(patternIndex);
  if (options.bannedRoutes != null) {
    Route route=trip.getRoute();
    RouteSpec spec=new RouteSpec(route.getId().getAgencyId(),GtfsLibrary.getRouteName(route));
    if (options.bannedRoutes.contains(spec)) {
      return null;
    }
  }
  state1.tripId=trip.getId();
  state1.setZoneAndRoute(getPattern().getZone(stopIndex),getPattern().getExemplar().getRoute().getId(),getPattern().getFareContext());
  if (options.optimizeFor == OptimizeType.TRANSFERS && state0.getTrip() != -1) {
    transfer_penalty+=options.optimizeTransferPenalty;
  }
  long wait_cost=wait;
  if (state0.numBoardings == 0) {
    wait_cost*=options.waitAtBeginningFactor;
  }
 else {
    wait_cost*=options.waitReluctance;
  }
  return new TraverseResult(wait_cost + options.boardCost + transfer_penalty,state1,this);
}
