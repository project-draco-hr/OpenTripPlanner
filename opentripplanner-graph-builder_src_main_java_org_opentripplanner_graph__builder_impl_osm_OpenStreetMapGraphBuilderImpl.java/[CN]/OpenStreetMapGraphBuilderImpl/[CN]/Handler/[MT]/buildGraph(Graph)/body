{
  Set<Integer> nodesWithNeighbors=new HashSet<Integer>();
  for (  OSMWay way : _ways.values()) {
    List<Integer> nodes=way.getNodeRefs();
    if (nodes.size() > 1)     nodesWithNeighbors.addAll(nodes);
  }
  _nodes.keySet().retainAll(nodesWithNeighbors);
  pruneFloatingIslands();
  HashMap<Coordinate,ArrayList<Edge>> edgesByLocation=new HashMap<Coordinate,ArrayList<Edge>>();
  int wayIndex=0;
  for (  OSMWay way : _ways.values()) {
    if (wayIndex % 1000 == 0)     _log.debug("ways=" + wayIndex + "/"+ _ways.size());
    wayIndex++;
    StreetTraversalPermission permissions=getPermissionsForEntity(way);
    if (permissions == StreetTraversalPermission.NONE)     continue;
    List<Integer> nodes=way.getNodeRefs();
    for (int i=0; i < nodes.size() - 1; i++) {
      Integer startNode=nodes.get(i);
      String vFromId=getVertexIdForNodeId(startNode) + "_" + i+ "_"+ way.getId();
      Integer endNode=nodes.get(i + 1);
      String vToId=getVertexIdForNodeId(endNode) + "_" + i+ "_"+ way.getId();
      OSMNode osmStartNode=_nodes.get(startNode);
      OSMNode osmEndNode=_nodes.get(endNode);
      if (osmStartNode == null || osmEndNode == null)       continue;
      Vertex from=addVertex(graph,vFromId,osmStartNode);
      Vertex to=addVertex(graph,vToId,osmEndNode);
      ArrayList<Street> streets=getEdgesForStreet(from,to,way,permissions);
      for (      Street street : streets) {
        graph.addEdge(street);
        Vertex start=street.getFromVertex();
        ArrayList<Edge> edges=edgesByLocation.get(start.getCoordinate());
        if (edges == null) {
          edges=new ArrayList<Edge>(4);
          edgesByLocation.put(start.getCoordinate(),edges);
        }
        edges.add(street);
      }
    }
  }
  StreetUtils.createTurnEdges(graph,edgesByLocation);
}
