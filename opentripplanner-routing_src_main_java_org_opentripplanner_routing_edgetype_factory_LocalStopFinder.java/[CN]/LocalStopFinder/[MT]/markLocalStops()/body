{
  _log.debug("Finding local stops");
  patterns=new HashSet<TripPattern>();
  int total=0;
  for (  GraphVertex gv : graph.getVertices()) {
    if (gv.vertex instanceof TransitStop) {
      ((TransitStop)gv.vertex).setLocal(true);
      total++;
    }
    for (    Edge e : gv.getOutgoing()) {
      if (e instanceof PatternBoard) {
        TripPattern pattern=((PatternBoard)e).getPattern();
        patterns.add(pattern);
      }
    }
  }
  neighborhoods=new HashMap<Stop,HashMap<TripPattern,P2<Double>>>();
  walkingOptions=new TraverseOptions();
  walkingOptions.modes=new TraverseModeSet(TraverseMode.WALK);
  bikingOptions=new TraverseOptions();
  bikingOptions.modes=new TraverseModeSet(TraverseMode.BICYCLE);
  bikingOptions.optimizeFor=OptimizeType.SAFE;
  int nonLocal=0;
  for (  TripPattern pattern : patterns) {
    List<Stop> stops=getStops(pattern);
    HashMap<TripPattern,P2<Double>> previousDistances=null;
    HashMap<TripPattern,P2<Double>> distances=null;
    for (int i=0; i < stops.size() - 1; ++i) {
      Stop stop=stops.get(i);
      TransitStop transitStop=getVertexForStop(stop);
      previousDistances=distances;
      distances=getNeighborhood(stop);
      HashMap<TripPattern,P2<Double>> nextDistances=null;
      Stop nextStop=stops.get(i + 1);
      nextDistances=getNeighborhood(nextStop);
      if (previousDistances == null) {
        if (!transitStop.isLocal()) {
          nonLocal++;
          transitStop.setLocal(false);
        }
        continue;
      }
 else {
        boolean local=true;
        for (        Entry<TripPattern,P2<Double>> entry : distances.entrySet()) {
          TripPattern key=entry.getKey();
          if (key == pattern) {
            continue;
          }
          P2<Double> distance=entry.getValue();
          P2<Double> previousDistance=previousDistances.get(key);
          P2<Double> nextDistance=nextDistances.get(key);
          if (previousDistance == null) {
            if (nextDistance == null || nextDistance.getFirst() > distance.getFirst() || nextDistance.getSecond() > distance.getSecond()) {
              local=false;
              break;
            }
          }
 else           if (distance.getFirst() + MAX_SUBOPTIMAL_DISTANCE < previousDistance.getFirst() && (nextDistance == null || nextDistance.getFirst() > distance.getFirst())) {
            local=false;
            break;
          }
 else           if (distance.getSecond() + MAX_SUBOPTIMAL_DISTANCE < previousDistance.getSecond() && (nextDistance == null || nextDistance.getSecond() > distance.getSecond())) {
            local=false;
            break;
          }
        }
        if (local == false) {
          if (transitStop.isLocal()) {
            nonLocal++;
          }
          transitStop.setLocal(false);
        }
      }
    }
    Stop stop=stops.get(stops.size() - 1);
    TransitStop transitStop=getVertexForStop(stop);
    if (!transitStop.isLocal()) {
      nonLocal++;
      transitStop.setLocal(false);
    }
  }
  _log.debug("Local stops: " + (total - nonLocal) + " / "+ total);
}
