{
  STRtree index=new STRtree();
  for (  Vertex v : graph.getVertices()) {
    index.insert(new Envelope(v.getCoordinate()),v);
  }
  for (  Vertex v : graph.getVertices()) {
    if (v.getType() == TransitStop.class) {
      Envelope env=new Envelope(v.getCoordinate());
      env.expandBy(0.0018);
      List<Vertex> nearby=(List<Vertex>)index.query(env);
      Vertex nearestIntersection=null;
      double minDistance=1000000000;
      Coordinate coord=v.getCoordinate();
      double lat1=coord.y;
      double lon1=coord.x;
      for (      Vertex nv : nearby) {
        if (nv == v) {
          continue;
        }
        coord=nv.getCoordinate();
        double lat2=coord.y;
        double lon2=coord.x;
        double distance=GtfsLibrary.distance(lat1,lon1,lat2,lon2) * 2;
        if (nv.getType() == TransitStop.class) {
          graph.addEdge(new Transfer(v,nv,distance));
          graph.addEdge(new Transfer(nv,v,distance));
        }
 else         if (nv.getType() == Intersection.class) {
          if (distance < minDistance) {
            minDistance=distance;
            nearestIntersection=nv;
          }
        }
      }
      if (nearestIntersection != null) {
        graph.addEdge(new StreetTransitLink(nearestIntersection,v));
        graph.addEdge(new StreetTransitLink(v,nearestIntersection));
      }
    }
  }
}
