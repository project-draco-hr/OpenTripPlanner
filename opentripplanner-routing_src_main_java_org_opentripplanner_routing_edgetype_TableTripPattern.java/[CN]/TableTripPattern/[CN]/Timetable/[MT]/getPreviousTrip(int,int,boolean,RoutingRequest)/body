{
  boolean pickup=false;
  int mask=pickup ? MASK_PICKUP : MASK_DROPOFF;
  int shift=pickup ? SHIFT_PICKUP : SHIFT_DROPOFF;
  if ((perStopFlags[stopIndex + 1] & mask) >> shift == NO_PICKUP) {
    return null;
  }
  boolean wheelchair=options.wheelchairAccessible;
  if (wheelchair && (perStopFlags[stopIndex + 1] & FLAG_WHEELCHAIR_ACCESSIBLE) == 0) {
    return null;
  }
  if (arrivalsIndex != null) {
    TripTimes[] index=arrivalsIndex[stopIndex];
    int tripIndex=TripTimes.binarySearchArrivals(index,stopIndex,beforeTime);
    while (tripIndex >= 0) {
      TripTimes tt=index[tripIndex];
      Trip t=tt.getTrip();
      if (tripAcceptable(t,haveBicycle,wheelchair) && !options.bannedTrips.contains(t.getId())) {
        return tt;
      }
      tripIndex-=1;
    }
    return null;
  }
  TripTimes bestTrip=null;
  int bestTime=Integer.MIN_VALUE;
  for (int i=0; i < trips.size(); i++) {
    TripTimes currTrip=tripTimes.get(i);
    int currTime=currTrip.getArrivalTime(stopIndex);
    if (currTime <= beforeTime && currTime > bestTime && tripAcceptable(currTrip.getTrip(),haveBicycle,wheelchair) && !options.bannedTrips.contains(trips.get(i).getId())) {
      bestTrip=currTrip;
      bestTime=currTime;
    }
  }
  return bestTrip;
}
