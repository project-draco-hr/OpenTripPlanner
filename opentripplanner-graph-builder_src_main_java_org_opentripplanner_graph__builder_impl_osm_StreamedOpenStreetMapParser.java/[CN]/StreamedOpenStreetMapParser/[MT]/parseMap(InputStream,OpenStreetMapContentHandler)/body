{
  XMLInputFactory inputFactory=XMLInputFactory.newInstance();
  XMLEventReader xmlEventReader=inputFactory.createXMLEventReader(in);
  OSMRelation osmRelation=null;
  OSMNode osmNode=null;
  OSMWay osmWay=null;
  while (xmlEventReader.hasNext()) {
    XMLEvent xmlEvent=xmlEventReader.nextEvent();
    if (xmlEvent.isStartElement()) {
      StartElement element=xmlEvent.asStartElement();
      if (element.getName().equals(qNode)) {
        osmNode=new OSMNode();
        osmNode.setId(Integer.parseInt(element.getAttributeByName(qId).getValue()));
        osmNode.setLat(Double.parseDouble(element.getAttributeByName(qLat).getValue()));
        osmNode.setLon(Double.parseDouble(element.getAttributeByName(qLon).getValue()));
      }
 else       if (element.getName().equals(qWay)) {
        osmWay=new OSMWay();
        osmWay.setId(Integer.parseInt(element.getAttributeByName(qId).getValue()));
      }
 else       if (element.getName().equals(qRelation)) {
        osmRelation=new OSMRelation();
        osmRelation.setId(Integer.parseInt(element.getAttributeByName(qId).getValue()));
      }
 else       if (element.getName().equals(qMember)) {
        OSMRelationMember relMember=new OSMRelationMember();
        relMember.setType(element.getAttributeByName(qType).getValue());
        relMember.setRole(element.getAttributeByName(qRole).getValue());
        relMember.setRef(Integer.parseInt(element.getAttributeByName(qRef).getValue()));
        osmRelation.addMember(relMember);
      }
 else       if (element.getName().equals(qNd)) {
        OSMNodeRef nodeRef=new OSMNodeRef();
        nodeRef.setRef(Integer.parseInt(element.getAttributeByName(qRef).getValue()));
        osmWay.addNodeRef(nodeRef);
      }
 else       if (element.getName().equals(qTag)) {
        OSMTag tag=new OSMTag();
        String key=element.getAttributeByName(qKey).getValue();
        tag.setK(key.intern());
        String value=element.getAttributeByName(qVal).getValue();
        if (key.equals("name") || key.equals("ref") || key.equals("highway")) {
          value=value.intern();
        }
        tag.setV(value);
        if (osmNode != null) {
          osmNode.addTag(tag);
        }
 else         if (osmWay != null) {
          osmWay.addTag(tag);
        }
 else         if (osmRelation != null) {
          osmRelation.addTag(tag);
        }
      }
    }
 else     if (xmlEvent.isEndElement()) {
      EndElement element=xmlEvent.asEndElement();
      if (element.getName().equals(qNode)) {
        map.addNode(osmNode);
        osmNode=null;
      }
 else       if (element.getName().equals(qWay)) {
        map.addWay(osmWay);
        osmWay=null;
      }
 else       if (element.getName().equals(qRelation)) {
        map.addRelation(osmRelation);
        osmRelation=null;
      }
    }
  }
  xmlEventReader.close();
}
