{
  ServiceDate serviceDate=new ServiceDate(Calendar.getInstance());
  String modifiedTripId="10.1";
  String modifiedTripAgency="agency";
  TripUpdate tripUpdate;
{
    TripDescriptor.Builder tripDescriptorBuilder=TripDescriptor.newBuilder();
    tripDescriptorBuilder.setTripId(modifiedTripId);
    tripDescriptorBuilder.setScheduleRelationship(TripDescriptor.ScheduleRelationship.MODIFIED);
    tripDescriptorBuilder.setStartDate(serviceDate.getAsString());
    Calendar calendar=serviceDate.getAsCalendar(graph.getTimeZone());
    long midnightSecondsSinceEpoch=calendar.getTimeInMillis() / 1000;
    TripUpdate.Builder tripUpdateBuilder=TripUpdate.newBuilder();
    tripUpdateBuilder.setTrip(tripDescriptorBuilder);
{
      StopTimeUpdate.Builder stopTimeUpdateBuilder=tripUpdateBuilder.addStopTimeUpdateBuilder();
      stopTimeUpdateBuilder.setScheduleRelationship(StopTimeUpdate.ScheduleRelationship.SCHEDULED);
      stopTimeUpdateBuilder.setStopId("O");
      stopTimeUpdateBuilder.setStopSequence(10);
{
        StopTimeEvent.Builder arrivalBuilder=stopTimeUpdateBuilder.getArrivalBuilder();
        arrivalBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (30 * 60));
        arrivalBuilder.setDelay(0);
      }
{
        StopTimeEvent.Builder departureBuilder=stopTimeUpdateBuilder.getDepartureBuilder();
        departureBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (30 * 60));
        departureBuilder.setDelay(0);
      }
    }
{
      StopTimeUpdate.Builder stopTimeUpdateBuilder=tripUpdateBuilder.addStopTimeUpdateBuilder();
      stopTimeUpdateBuilder.setScheduleRelationship(StopTimeUpdate.ScheduleRelationship.SCHEDULED);
      stopTimeUpdateBuilder.setStopId("C");
      stopTimeUpdateBuilder.setStopSequence(30);
{
        StopTimeEvent.Builder arrivalBuilder=stopTimeUpdateBuilder.getArrivalBuilder();
        arrivalBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (40 * 60));
        arrivalBuilder.setDelay(0);
      }
{
        StopTimeEvent.Builder departureBuilder=stopTimeUpdateBuilder.getDepartureBuilder();
        departureBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (45 * 60));
        departureBuilder.setDelay(0);
      }
    }
{
      StopTimeUpdate.Builder stopTimeUpdateBuilder=tripUpdateBuilder.addStopTimeUpdateBuilder();
      stopTimeUpdateBuilder.setScheduleRelationship(StopTimeUpdate.ScheduleRelationship.SKIPPED);
      stopTimeUpdateBuilder.setStopId("D");
      stopTimeUpdateBuilder.setStopSequence(40);
{
        StopTimeEvent.Builder arrivalBuilder=stopTimeUpdateBuilder.getArrivalBuilder();
        arrivalBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (50 * 60));
        arrivalBuilder.setDelay(0);
      }
{
        StopTimeEvent.Builder departureBuilder=stopTimeUpdateBuilder.getDepartureBuilder();
        departureBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (51 * 60));
        departureBuilder.setDelay(0);
      }
    }
{
      StopTimeUpdate.Builder stopTimeUpdateBuilder=tripUpdateBuilder.addStopTimeUpdateBuilder();
      stopTimeUpdateBuilder.setScheduleRelationship(StopTimeUpdate.ScheduleRelationship.SCHEDULED);
      stopTimeUpdateBuilder.setStopId("P");
      stopTimeUpdateBuilder.setStopSequence(50);
{
        StopTimeEvent.Builder arrivalBuilder=stopTimeUpdateBuilder.getArrivalBuilder();
        arrivalBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (55 * 60));
        arrivalBuilder.setDelay(0);
      }
{
        StopTimeEvent.Builder departureBuilder=stopTimeUpdateBuilder.getDepartureBuilder();
        departureBuilder.setTime(midnightSecondsSinceEpoch + (12 * 3600) + (55 * 60));
        departureBuilder.setDelay(0);
      }
    }
    tripUpdate=tripUpdateBuilder.build();
  }
  updater.applyTripUpdates(graph,fullDataset,Arrays.asList(tripUpdate),modifiedTripAgency);
  TimetableSnapshot snapshot=updater.getTimetableSnapshot();
{
    AgencyAndId tripId=new AgencyAndId(modifiedTripAgency,modifiedTripId);
    Trip trip=graph.index.tripForId.get(tripId);
    TripPattern originalTripPattern=graph.index.patternForTrip.get(trip);
    Timetable originalTimetableForToday=snapshot.resolve(originalTripPattern,serviceDate);
    Timetable originalTimetableScheduled=snapshot.resolve(originalTripPattern,null);
    assertNotSame(originalTimetableForToday,originalTimetableScheduled);
    int originalTripIndexScheduled=originalTimetableScheduled.getTripIndex(modifiedTripId);
    assertTrue("Original trip should be found in scheduled time table",originalTripIndexScheduled > -1);
    TripTimes originalTripTimesScheduled=originalTimetableScheduled.getTripTimes(originalTripIndexScheduled);
    assertFalse("Original trip times should not be canceled in scheduled time table",originalTripTimesScheduled.isCanceled());
    int originalTripIndexForToday=originalTimetableForToday.getTripIndex(modifiedTripId);
    assertTrue("Original trip should be found in time table for service date",originalTripIndexForToday > -1);
    TripTimes originalTripTimesForToday=originalTimetableForToday.getTripTimes(originalTripIndexForToday);
    assertTrue("Original trip times should be canceled in time table for service date",originalTripTimesForToday.isCanceled());
  }
{
    TripPattern newTripPattern=snapshot.getLastAddedTripPattern(modifiedTripId,serviceDate);
    assertNotNull("New trip pattern should be found",newTripPattern);
    Timetable newTimetableForToday=snapshot.resolve(newTripPattern,serviceDate);
    Timetable newTimetableScheduled=snapshot.resolve(newTripPattern,null);
    assertNotSame(newTimetableForToday,newTimetableScheduled);
    assertTrue("New trip should be found in time table for service date",newTimetableForToday.getTripIndex(modifiedTripId) > -1);
    assertEquals("New trip should not be found in scheduled time table",-1,newTimetableScheduled.getTripIndex(modifiedTripId));
  }
}
