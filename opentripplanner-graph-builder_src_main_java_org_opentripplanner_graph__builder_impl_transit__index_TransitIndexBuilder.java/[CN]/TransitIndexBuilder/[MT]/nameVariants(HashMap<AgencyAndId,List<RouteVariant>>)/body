{
  for (  List<RouteVariant> variants : variantsByRoute.values()) {
    Route route=variants.get(0).getRoute();
    String routeName=GtfsLibrary.getRouteName(route);
    if (variants.size() == 1) {
      variants.get(0).setName(routeName);
      continue;
    }
    HashMap<String,List<RouteVariant>> starts=new HashMap<String,List<RouteVariant>>();
    HashMap<String,List<RouteVariant>> ends=new HashMap<String,List<RouteVariant>>();
    HashMap<String,List<RouteVariant>> vias=new HashMap<String,List<RouteVariant>>();
    for (    RouteVariant variant : variants) {
      List<Stop> stops=variant.getStops();
      MapUtils.addToMapList(starts,stops.get(0).getName(),variant);
      MapUtils.addToMapList(ends,stops.get(stops.size() - 1).getName(),variant);
      for (      Stop stop : stops) {
        MapUtils.addToMapList(vias,stop.getName(),variant);
      }
    }
    for (    RouteVariant variant : variants) {
      List<Stop> stops=variant.getStops();
      String firstStop=stops.get(0).getName();
      if (starts.get(firstStop).size() == 1) {
        String name=routeName + " from " + firstStop;
        variant.setName(name);
      }
 else {
        String lastStop=stops.get(stops.size() - 1).getName();
        if (ends.get(lastStop).size() == 1) {
          String name=routeName + " to " + lastStop;
          variant.setName(name);
        }
 else {
          for (          Stop stop : stops) {
            String viaStop=stop.getName();
            if (vias.get(viaStop).size() == 1) {
              String name=routeName + " via " + viaStop;
              variant.setName(name);
              break;
            }
          }
        }
      }
    }
    for (    RouteVariant variant : variants) {
      if (variant.getName() != null)       continue;
      List<Stop> stops=variant.getStops();
      String firstStop=stops.get(0).getName();
      HashSet<RouteVariant> remainingVariants=new HashSet<RouteVariant>(starts.get(firstStop));
      String lastStop=stops.get(stops.size() - 1).getName();
      remainingVariants.retainAll(ends.get(lastStop));
      if (remainingVariants.size() == 1) {
        String name=routeName + " from " + firstStop+ " to "+ lastStop;
        variant.setName(name);
        continue;
      }
      for (      Stop stop : stops) {
        if (stop.getName().equals(firstStop) || stop.getName().equals(lastStop)) {
          continue;
        }
        List<RouteVariant> via=vias.get(stop.getName());
        boolean found=false;
        boolean bad=false;
        for (        RouteVariant viaVariant : via) {
          if (remainingVariants.contains(viaVariant)) {
            if (found) {
              bad=true;
              break;
            }
 else {
              found=true;
            }
          }
        }
        if (found && !bad) {
          String name=routeName + " from " + firstStop+ " to "+ lastStop+ " via "+ stop.getName();
          variant.setName(name);
          break;
        }
      }
      if (variant.getName() == null) {
        if (remainingVariants.size() == 2) {
          variant.setName(routeName + " from " + firstStop+ " to "+ lastStop+ " express");
        }
 else {
          variant.setName(routeName + " like " + variant.getTrips().get(0).getId());
        }
      }
    }
  }
}
