{
  RouteVariant variant=variantsByTrip.get(trip.getId());
  if (variant != null) {
    variant.addTrip(trip);
    return variant;
  }
  if (trip.getDirectionId() != null) {
    AgencyAndId routeId=trip.getRoute().getId();
    String directionId=trip.getDirectionId();
    HashSet<String> directions=directionsByRoute.get(routeId);
    if (directions == null) {
      directions=new HashSet<String>();
      directionsByRoute.put(routeId,directions);
    }
    directions.add(directionId);
  }
  List<StopTime> stopTimes=dao.getStopTimesForTrip(trip);
  ArrayList<Stop> stops=new ArrayList<Stop>();
  for (  StopTime stopTime : stopTimes) {
    stops.add(stopTime.getStop());
  }
  Route route=trip.getRoute();
  List<RouteVariant> variants=variantsByRoute.get(route.getId());
  if (variants == null) {
    variants=new ArrayList<RouteVariant>();
    variantsByRoute.put(route.getId(),variants);
  }
  for (  RouteVariant existingVariant : variants) {
    if (existingVariant.getStops().equals(stops)) {
      variant=existingVariant;
      break;
    }
  }
  if (variant == null) {
    variant=new RouteVariant(route,stops);
    variants.add(variant);
  }
  variantsByTrip.put(trip.getId(),variant);
  variant.addTrip(trip);
  return variant;
}
