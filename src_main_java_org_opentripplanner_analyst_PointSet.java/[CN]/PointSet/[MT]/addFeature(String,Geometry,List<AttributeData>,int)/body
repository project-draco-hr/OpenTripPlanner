{
  if (index >= capacity) {
    throw new AssertionError("Number of features seems to have grown since validation.");
  }
  if (geom instanceof MultiPolygon) {
    if (geom.isEmpty()) {
      LOG.warn("Empty MultiPolygon, skipping.");
      return;
    }
    if (geom.getNumGeometries() > 1) {
      LOG.warn("Multiple polygons in MultiPolygon, using only the first.");
    }
    geom=geom.getGeometryN(0);
  }
  Point point;
  if (geom instanceof Point) {
    point=(Point)geom;
  }
 else   if (geom instanceof Polygon) {
    point=geom.getCentroid();
    polygons[index]=(Polygon)geom;
  }
 else {
    LOG.warn("Non-point, non-polygon Geometry, not supported.");
    return;
  }
  lats[index]=point.getCoordinate().y;
  lons[index]=point.getCoordinate().x;
  ids[index]=id;
  for (  AttributeData ad : attributes) {
    Attribute attr=getAttributeFor(ad.category,ad.attribute);
    if (attr == null)     continue;
    if (attr.magnitudes == null)     attr.magnitudes=new int[capacity];
    attr.magnitudes[index]=ad.value;
  }
}
