{
  RoutingRequest request=prototypeRoutingRequest.clone();
  request.setRouterId(get(routerId,n,request.getRouterId()));
  request.setFromString(get(fromPlace,n,request.getFromPlace().getRepresentation()));
  request.setToString(get(toPlace,n,request.getToPlace().getRepresentation()));
{
    String d=get(date,n,null);
    String t=get(time,n,null);
    TimeZone tz;
    if (graphService != null) {
      tz=graphService.getGraph(request.routerId).getTimeZone();
    }
 else {
      LOG.warn("no graph service available, using default timezone.");
      tz=TimeZone.getDefault();
    }
    if (d == null && t != null) {
      LOG.debug("parsing ISO datetime {}",t);
      try {
        request.setDateTime(javax.xml.datatype.DatatypeFactory.newInstance().newXMLGregorianCalendar(t).toGregorianCalendar().getTime());
      }
 catch (      DatatypeConfigurationException e) {
        request.setDateTime(d,t,tz);
      }
    }
 else {
      request.setDateTime(d,t,tz);
    }
  }
  request.setWheelchairAccessible(get(wheelchair,n,request.isWheelchairAccessible()));
  request.setNumItineraries(get(numItineraries,n,request.getNumItineraries()));
  request.setMaxWalkDistance(get(maxWalkDistance,n,request.getMaxWalkDistance()));
  request.setWalkReluctance(get(walkReluctance,n,request.getWalkReluctance()));
  request.setWalkSpeed(get(walkSpeed,n,request.getWalkSpeed()));
  double bikeSpeedParam=get(bikeSpeed,n,request.getBikeSpeed());
  request.setBikeSpeed(bikeSpeedParam);
  OptimizeType opt=get(optimize,n,request.getOptimize());
{
    Double tsafe=get(triangleSafetyFactor,n,null);
    Double tslope=get(triangleSlopeFactor,n,null);
    Double ttime=get(triangleTimeFactor,n,null);
    if (tsafe != null || tslope != null || ttime != null) {
      if (tsafe == null || tslope == null || ttime == null) {
        throw new ParameterException(Message.UNDERSPECIFIED_TRIANGLE);
      }
      if (opt == null) {
        opt=OptimizeType.TRIANGLE;
      }
 else       if (opt != OptimizeType.TRIANGLE) {
        throw new ParameterException(Message.TRIANGLE_OPTIMIZE_TYPE_NOT_SET);
      }
      if (Math.abs(tsafe + tslope + ttime - 1) > Math.ulp(1) * 3) {
        throw new ParameterException(Message.TRIANGLE_NOT_AFFINE);
      }
      request.setTriangleSafetyFactor(tsafe);
      request.setTriangleSlopeFactor(tslope);
      request.setTriangleTimeFactor(ttime);
    }
 else     if (opt == OptimizeType.TRIANGLE) {
      throw new ParameterException(Message.TRIANGLE_VALUES_NOT_SET);
    }
  }
  request.setArriveBy(get(arriveBy,n,false));
  request.setShowIntermediateStops(get(showIntermediateStops,n,request.isShowIntermediateStops()));
  if (intermediatePlaces != null && intermediatePlaces.size() > 0 && !intermediatePlaces.get(0).equals("")) {
    request.setIntermediatePlacesFromStrings(intermediatePlaces);
  }
  if (intermediatePlacesOrdered == null)   intermediatePlacesOrdered=request.isIntermediatePlacesOrdered();
  request.setIntermediatePlacesOrdered(intermediatePlacesOrdered);
  request.setPreferredRoutes(get(preferredRoutes,n,request.getPreferredRouteStr()));
  request.setOtherThanPreferredRoutesPenalty(get(otherThanPreferredRoutesPenalty,n,request.getOtherThanPreferredRoutesPenalty()));
  request.setPreferredAgencies(get(preferredAgencies,n,request.getPreferredAgenciesStr()));
  request.setUnpreferredRoutes(get(unpreferredRoutes,n,request.getUnpreferredRouteStr()));
  request.setUnpreferredAgencies(get(unpreferredAgencies,n,request.getUnpreferredAgenciesStr()));
  request.setBannedRoutes(get(bannedRoutes,n,request.getBannedRouteStr()));
  request.setBannedAgencies(get(bannedAgencies,n,request.getBannedAgenciesStr()));
  HashMap<AgencyAndId,BannedStopSet> bannedTripMap=makeBannedTripMap(get(bannedTrips,n,null));
  if (bannedTripMap != null) {
    request.setBannedTrips(bannedTripMap);
  }
  request.setBannedStops(get(bannedStops,n,request.getBannedStopsStr()));
  if (opt == OptimizeType.TRANSFERS) {
    opt=OptimizeType.QUICK;
    request.setTransferPenalty(get(transferPenalty,n,0) + 1800);
  }
 else {
    request.setTransferPenalty(get(transferPenalty,n,request.getTransferPenalty()));
  }
  request.setBatch(get(batch,n,new Boolean(request.isBatch())));
  request.setOptimize(opt);
  TraverseModeSet modeSet=get(modes,n,request.getModes());
  request.setModes(modeSet);
  if (modeSet.getBicycle() && modeSet.getWalk() && bikeSpeedParam == -1) {
    request.setBikeSpeed(4.3);
  }
  request.setBoardSlack(get(boardSlack,n,request.getBoardSlack()));
  request.setAlightSlack(get(alightSlack,n,request.getAlightSlack()));
  request.setTransferSlack(get(minTransferTime,n,request.getTransferSlack()));
  request.setNonpreferredTransferPenalty(get(nonpreferredTransferPenalty,n,request.getNonpreferredTransferPenalty()));
  if (request.getBoardSlack() + request.getAlightSlack() > request.getTransferSlack()) {
    throw new RuntimeException("Invalid parameters: transfer slack must " + "be greater than or equal to board slack plus alight slack");
  }
  request.setMaxTransfers(get(maxTransfers,n,request.getMaxTransfers()));
  final long NOW_THRESHOLD_MILLIS=15 * 60 * 60* 1000;
  boolean tripPlannedForNow=Math.abs(request.getDateTime().getTime() - new Date().getTime()) < NOW_THRESHOLD_MILLIS;
  request.setUseBikeRentalAvailabilityInformation(tripPlannedForNow);
  if (request.getIntermediatePlaces() != null && (request.getModes().isTransit() || (request.getModes().getWalk() && request.getModes().getBicycle())))   throw new UnsupportedOperationException("TSP is not supported for transit or bike share trips");
  String startTransitStopId=get(this.startTransitStopId,n,AgencyAndId.convertToString(request.getStartingTransitStopId()));
  if (startTransitStopId != null && !"".equals(startTransitStopId)) {
    request.setStartingTransitStopId(AgencyAndId.convertFromString(startTransitStopId));
  }
  String startTransitTripId=get(this.startTransitTripId,n,AgencyAndId.convertToString(request.getStartingTransitTripId()));
  if (startTransitTripId != null && !"".equals(startTransitTripId)) {
    request.setStartingTransitTripId(AgencyAndId.convertFromString(startTransitTripId));
  }
  request.setClampInitialWait(get(clampInitialWait,n,request.getClampInitialWait()));
  request.setReverseOptimizeOnTheFly(get(reverseOptimizeOnTheFly,n,request.isReverseOptimizeOnTheFly()));
  String localeSpec=get(locale,n,"en");
  String[] localeSpecParts=localeSpec.split("_");
  Locale locale;
switch (localeSpecParts.length) {
case 1:
    locale=new Locale(localeSpecParts[0]);
  break;
case 2:
locale=new Locale(localeSpecParts[0]);
break;
case 3:
locale=new Locale(localeSpecParts[0]);
break;
default :
LOG.debug("Bogus locale " + localeSpec + ", defaulting to en");
locale=new Locale("en");
}
request.setLocale(locale);
return request;
}
