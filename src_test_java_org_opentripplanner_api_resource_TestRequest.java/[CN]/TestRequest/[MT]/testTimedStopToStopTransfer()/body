{
  ServiceDate serviceDate=new ServiceDate(2009,10,01);
  TestPlanner planner=new TestPlanner("portland","45.506077,-122.621139","45.464637,-122.706061");
  TransferTable table=new TransferTable();
  Graph graph=Context.getInstance().graph;
  when(graph.getTransferTable()).thenReturn(table);
  Response response=planner.getItineraries();
  Itinerary itinerary=response.getPlan().itinerary.get(0);
  assertEquals("751W1320",itinerary.legs.get(1).tripId);
  assertEquals("91W1350",itinerary.legs.get(3).tripId);
  addStopToStopTransferTimeToTable(table,"7528","9756",StopTransfer.TIMED_TRANSFER);
  Vertex fromVertex=graph.getVertex("TriMet_7528_arrive");
  Vertex toVertex=graph.getVertex("TriMet_9756_depart");
  TimedTransferEdge timedTransferEdge=new TimedTransferEdge(fromVertex,toVertex);
  response=planner.getItineraries();
  itinerary=response.getPlan().itinerary.get(0);
  assertEquals("750W1300",itinerary.legs.get(1).tripId);
  assertEquals("120W1320",itinerary.legs.get(3).tripId);
  Trip trip=graph.index.tripForId.get(new AgencyAndId("TriMet","120W1320"));
  TripPattern pattern=graph.index.patternForTrip.get(trip);
  applyUpdateToTripPattern(pattern,"120W1320","9756",22,41580,41580,ScheduleRelationship.SCHEDULED,0,serviceDate);
  response=planner.getItineraries();
  itinerary=response.getPlan().itinerary.get(0);
  assertEquals("750W1300",itinerary.legs.get(1).tripId);
  assertEquals("120W1320",itinerary.legs.get(3).tripId);
  applyUpdateToTripPattern(pattern,"120W1320","9756",22,41579,41579,ScheduleRelationship.SCHEDULED,0,serviceDate);
  response=planner.getItineraries();
  itinerary=response.getPlan().itinerary.get(0);
  assertFalse("190W1280".equals(itinerary.legs.get(1).tripId) && "751W1330".equals(itinerary.legs.get(3).tripId));
  applyUpdateToTripPattern(pattern,"120W1320","9756",22,41820,41820,ScheduleRelationship.SCHEDULED,0,serviceDate);
  timedTransferEdge.detach();
  reset(graph);
}
